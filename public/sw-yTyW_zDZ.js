var ee=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var mi=ee(w=>{const R={test:location.search.indexOf("test=1")>0,debug:location.search.indexOf("debug=1")>0,http:!1,ssl:!0,asServiceWorker:!1,transport:"websocket",noSharedWorker:location.search.indexOf("noSharedWorker=1")>0,multipleTransports:!0};(R.http=location.search.indexOf("http=1")>0)&&(R.multipleTransports=!1);R.multipleTransports&&(R.http=!0);R.http&&(R.transport="https");const Ut=R.debug,ie=typeof window<"u"?window:self,wt=ie,O=typeof window<"u"?window:self,X=navigator?navigator.userAgent:null;navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i);navigator.userAgent.toLowerCase().indexOf("android");(()=>{try{return+navigator.userAgent.match(/Chrom(?:e|ium)\/(.+?)(?:\s|\.)/)[1]}catch{}})();const It="safari"in O||!!(X&&(/\b(iPad|iPhone|iPod)\b/.test(X)||X.match("Safari")&&!X.match("Chrome"))),Pt=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(navigator.maxTouchPoints===void 0||navigator.maxTouchPoints>0)&&navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i)!=-1;const st=typeof ServiceWorkerGlobalScope<"u"&&self instanceof ServiceWorkerGlobalScope,ht=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&!st,se=ht||st,Ft=()=>self.clients.matchAll({includeUncontrolled:!1,type:"window"}),kt=(t,...e)=>{try{t.postMessage(...e)}catch(s){console.error("[worker] postMessage error:",s,e)}},zt=(t,...e)=>{Ft().then(s=>{s.length&&s.slice(t?0:-1).forEach(n=>{kt(n,...e)})})},Lt=(...t)=>{kt(self,...t)},Dt=()=>{};st&&zt.bind(null,!1);st&&zt.bind(null,!0);const ne=Date.now();function Et(){return"["+((Date.now()-ne)/1e3).toFixed(3)+"]"}var $=(t=>(t[t.None=0]="None",t[t.Error=1]="Error",t[t.Warn=2]="Warn",t[t.Log=4]="Log",t[t.Debug=8]="Debug",t))($||{});const re=[0,1,2,4,8],oe=It||Pt,ae=!oe,At={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},he=[["debug",8],["info",4],["warn",2],["error",1],["assert",1],["trace",4],["group",4],["groupCollapsed",4],["groupEnd",4]];function nt(t,e=7,s=!1,n=""){let o;!Ut&&!s&&(e=1),ae?n||(st?n=At.fg.yellow:ht&&(n=At.fg.cyan)):n="";const a=n;n?n=`%s ${n}%s`:n="%s";const h=function(...l){return e&4&&console.log(n,Et(),t,...l)};return he.forEach(([l,f])=>{h[l]=function(...c){return e&f&&console[l](n,Et(),t,...c)}}),h.setPrefix=function(l){o=l,t="["+l+"]"},h.setPrefix(t),h.setLevel=function(l){e=re.slice(0,l+1).reduce((f,c)=>f|c,0)},h.bindPrefix=function(l,f=e){return nt(`${o}] [${l}`,f,s,a)},h}function Rt(t){return new Promise(e=>{setTimeout(e,t)})}const le=self,Nt="cachedAssets";function dt(t){return t.ok&&t.status===200}function Tt(t){return Promise.race([t,Rt(1e4).then(()=>Promise.reject())])}async function fe(t){try{const e=await Tt(le.caches.open(Nt)),s=await Tt(e.match(t.request,{ignoreVary:!0}));if(s&&dt(s))return s;const n={Vary:"*"};let o=await fetch(t.request,{headers:n});if(dt(o))e.put(t.request,o.clone());else if(o.status===304){const a=t.request.url.replace(/\?.+$/,"")+"?"+(Math.random()*1e5|0);o=await fetch(a,{headers:n}),dt(o)&&e.put(t.request,o.clone())}return o}catch{return fetch(t.request)}}function de(t,e){return new Promise(s=>{const n=new FileReader;n.addEventListener("loadend",o=>{s(o.target.result)}),n[e](t)})}function ce(t){return de(t,"readAsArrayBuffer")}function ue(t){return ce(t).then(e=>new Uint8Array(e))}function Mt(){}const pe={isFulfilled:!1,isRejected:!1,notify:()=>{},notifyAll:function(...t){this.lastNotify=t,this.listeners?.forEach(e=>e(...t))},addNotifyListener:function(t){this.lastNotify&&t(...this.lastNotify),(this.listeners??(this.listeners=[])).push(t)},resolve:function(t){this.isFulfilled||this.isRejected||(this.isFulfilled=!0,this._resolve(t),this.onFinish())},reject:function(...t){this.isRejected||this.isFulfilled||(this.isRejected=!0,this._reject(...t),this.onFinish())},onFinish:function(){this.notify=this.notifyAll=this.lastNotify=null,this.listeners&&(this.listeners.length=0),this.cancel&&(this.cancel=Mt)}};function lt(){let t,e;const s=new Promise((n,o)=>{t=n,e=o});return Object.assign(s,pe),s._resolve=t,s._reject=e,s}self.deferredPromise=lt;function _e(t,e,s=!0,n=!0){let o,a,h,l,f=!1;const c=_=>{const m=h,g=l;try{const v=t.apply(null,_);m(v)}catch(v){console.error("debounce error",v),g(v)}},p=(..._)=>{a||(a=new Promise((g,v)=>(h=g,l=v))),o?(clearTimeout(o),f=!0,l(),a=new Promise((g,v)=>(h=g,l=v))):s&&(c(_),f=!1);const m=O.setTimeout(()=>{n&&(!s||f)&&c(_),o===m&&(o=a=h=l=void 0,f=!1)},e);return o=m,a.catch(Mt),a};return p.clearTimeout=()=>{o&&(O.clearTimeout(o),l(),o=a=h=l=void 0,f=!1)},p.isDebounced=()=>!!o,p}function ge(t){return["image/jpeg","image/png","image/gif","image/svg+xml","image/webp","image/bmp","video/mp4","video/webm","video/quicktime","audio/ogg","audio/mpeg","audio/mp4","audio/wav","application/json","application/pdf"].indexOf(t)===-1?"application/octet-stream":t}function Ot(t,e=""){Array.isArray(t)||(t=[t]);const s=ge(e);return new Blob(t,{type:s})}class ye{constructor(e,s,n){this.mimeType=e,this.size=s,this.saveFileCallback=n,this.bytes=new Uint8Array(s)}async write(e,s){const n=s+e.byteLength;if(n>this.bytes.byteLength){const o=new Uint8Array(n);o.set(this.bytes,0),this.bytes=o}this.bytes.set(e,s)}truncate(){this.bytes=new Uint8Array}trim(e){this.bytes=this.bytes.slice(0,e)}finalize(e=!0){const s=Ot(this.bytes,this.mimeType);return e&&this.saveFileCallback&&this.saveFileCallback(s),s}getParts(){return this.bytes}replaceParts(e){this.bytes=e}}const ct={};function et(t){return ct[t]??(ct[t]={type:t})}const Y=class Y{constructor(e){this.dbName=e,this.useStorage=!0,R.test&&(this.dbName+="_test"),Y.STORAGES.length&&(this.useStorage=Y.STORAGES[0].useStorage),this.openDatabase(),Y.STORAGES.push(this)}openDatabase(){return this.openDbPromise??(this.openDbPromise=caches.open(this.dbName))}delete(e){return this.timeoutOperation(s=>s.delete("/"+e))}deleteAll(){return caches.delete(this.dbName)}get(e){return this.timeoutOperation(s=>s.match("/"+e))}save(e,s){return this.timeoutOperation(n=>n.put("/"+e,s))}getFile(e,s="blob"){return this.get(e).then(n=>{if(!n)throw et("NO_ENTRY_FOUND");return n[s]()})}saveFile(e,s){s instanceof Blob||(s=Ot(s));const n=new Response(s,{headers:{"Content-Length":""+s.size}});return this.save(e,n).then(()=>s)}timeoutOperation(e){return this.useStorage?new Promise(async(s,n)=>{let o=!1;const a=setTimeout(()=>{n(),o=!0},15e3);try{const h=await this.openDatabase();if(!h)throw this.useStorage=!1,this.openDbPromise=void 0,"no cache?";const l=await e(h);if(o)return;s(l)}catch(h){n(h)}clearTimeout(a)}):Promise.reject(et("STORAGE_OFFLINE"))}prepareWriting(e,s,n){return{deferred:lt(),getWriter:()=>new ye(n,s,a=>this.saveFile(e,a).catch(()=>a))}}static toggleStorage(e,s){return Promise.all(this.STORAGES.map(n=>{if(n.useStorage=e,!!s&&!e)return n.deleteAll()}))}};Y.STORAGES=[];let rt=Y;function ut(t){let e=0,s;for(s=0;s<4;s++){const n=t[s]&255;if(e<<=7,e|=n&127,!(n&128))break}return{size:e,byteLength:s+1}}const Bt={moov(t){M(t)},trak(t){M(t)},mdia(t){M(t)},minf(t){M(t)},stbl(t){M(t)},stsd(t){M(t.subarray(8))},mp4a(t){M(t.subarray(28))},esds(t){t=t.subarray(5);const e=ut(t);t=t.subarray(e.byteLength),t=t.subarray(2);const s=t[0];for(t=t.subarray(1),(s>>7&1)===1&&(t=t.subarray(2)),(s>>6&1)===1&&(t=t.subarray(t[0]+1)),(s>>5&1)===1&&(t=t.subarray(2));t.byteLength;){const n=t[0];t=t.subarray(1);let o=ut(t);if(t=t.subarray(o.byteLength),n!==4){t=t.subarray(o.size);continue}if(t=t.subarray(13),o.size>13&&t[0]===5){t=t.subarray(1),o=ut(t),t=t.subarray(o.byteLength);const a=t.subarray(0,o.size);a.byteLength>=2&&(a[0]=19,a[1]=144)}break}}},me="moov mvhd trak tkhd mdia mdhd minf hdlr vmhd smhd stbl stsz stco stss stts stsc co64 stsd ctts avc1 avcC hev1 hvc1 hvcC mp4a esds mdat ftyp".split(/\s/),K={};function M(t,e,s){if(!(e in K&&s+t.byteLength<K[e])){if(e in K){const n=K[e]-s;n>0&&t.byteLength-n>0&&(t=t.subarray(n))}for(;t.byteLength>=8;){const n=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0),o=String.fromCharCode(...t.subarray(4,8)),a=n>1?n:t.byteLength,h=t.subarray(8,a);if(!me.includes(o)){t=t.subarray(1);continue}if(o=="mdat"){const l=n-t.byteLength,f=s+t.byteOffset+t.byteLength+l;K[e]=f}o in Bt&&h.byteLength==n-8&&Bt[o](h),t=t.subarray(a)}}}function ve(t){return new Promise(e=>{setTimeout(()=>{e(new Response("",{status:408,statusText:"Request timed out."}))},t)})}const J=new Map,yt=new rt("cachedStreamChunks"),Se=86400,Gt="Time-Cached",xe=()=>yt.timeoutOperation(t=>t.keys().then(e=>{const s=new Map,n=Date.now()/1e3|0;for(const a of e){const h=a.url.match(/\/(\d+?)\?/);h&&!s.has(h[1])&&s.set(h[1],a)}const o=[];for(const[a,h]of s){const l=t.match(h).then(f=>{if(+f.headers.get(Gt)+Se<=n)return U("will delete stream chunk:",a),t.delete(h,{ignoreSearch:!0,ignoreVary:!0})});o.push(l)}return Promise.all(o)}));setInterval(xe,18e5);setInterval(()=>{const t=$t();for(const[e,s]of J)if(e!==t){for(const n in s)s[n].reject();J.delete(e)}},12e4);const pt=new Map;class ot{constructor(e){this.info=e,this.loadedOffsets=new Set,this.destroy=()=>{pt.delete(this.id)},this.id=ot.getId(e),pt.set(this.id,this),this.limitPart=e.size>75*1024*1024?Ee:we,this.destroyDebounced=_e(this.destroy,15e4,!1,!0)}async requestFilePartFromWorker(e,s,n=!1){const o={docId:this.id,dcId:this.info.dcId,offset:e,limit:s},a=JSON.stringify(o),h=$t();let l=J.get(h);l||J.set(h,l={});let f=l[a];if(f)return f.then(p=>p.bytes);this.loadedOffsets.add(e),f=l[a]=lt(),C.invoke("requestFilePart",o,void 0,h).then(f.resolve.bind(f),f.reject.bind(f)).finally(()=>{l[a]===f&&(delete l[a],Object.keys(l).length||J.delete(h))});const c=f.then(p=>p.bytes);return this.saveChunkToCache(c,e,s),!n&&this.preloadChunks(e,e+this.limitPart*15),c}requestFilePartFromCache(e,s,n){const o=this.getChunkKey(e,s);return yt.getFile(o).then(a=>n?new Uint8Array:ue(a),a=>{a.type})}requestFilePart(e,s,n){return this.requestFilePartFromCache(e,s,n).then(a=>a||this.requestFilePartFromWorker(e,s,n))}saveChunkToCache(e,s,n){return e.then(o=>{const a=this.getChunkKey(s,n),h=new Response(o,{headers:{"Content-Length":""+o.length,"Content-Type":"application/octet-stream",[Gt]:""+(Date.now()/1e3|0)}});return yt.save(a,h)})}preloadChunk(e){this.loadedOffsets.has(e)||(this.loadedOffsets.add(e),this.requestFilePart(e,this.limitPart,!0))}preloadChunks(e,s){if(s>this.info.size&&(s=this.info.size),!e)this.preloadChunk(Ct(e,this.limitPart));else for(;e<s;e+=this.limitPart)this.preloadChunk(e)}requestRange(e){this.destroyDebounced();const s=be(e,this.info.mimeType,this.info.size);if(s)return s;let[n,o]=e;const a=o&&o<this.limitPart?Be(o-n+1):this.limitPart,h=Ct(n,a);return o||(o=Math.min(n+a,this.info.size-1)),this.requestFilePart(h,a).then(l=>{(n!==h||o!==h+a)&&(l=l.slice(n-h,o-h+1));const f={"Accept-Ranges":"bytes","Content-Range":`bytes ${n}-${n+l.byteLength-1}/${this.info.size||"*"}`,"Content-Length":`${l.byteLength}`};return this.info.mimeType&&(f["Content-Type"]=this.info.mimeType,this.info.mimeType=="video/mp4"&&/Chrome/.test(X)&&M(l,String(this.id),n)),new Response(l,{status:206,statusText:"Partial Content",headers:f})})}getChunkKey(e,s){return this.id+"?offset="+e+"&limit="+s}static get(e){return pt.get(this.getId(e))??new ot(e)}static getId(e){return e.location.id}}function Ue(t,e){const s=Te(t.request.headers.get("Range")),n=JSON.parse(decodeURIComponent(e)),o=ot.get(n);t.respondWith(Promise.race([ve(45*1e3),o.requestRange(s)]))}function be(t,e,s){return t[0]===0&&t[1]===1?new Response(new Uint8Array(2).buffer,{status:206,statusText:"Partial Content",headers:{"Accept-Ranges":"bytes","Content-Range":`bytes 0-1/${s||"*"}`,"Content-Length":"2","Content-Type":e||"video/mp4"}}):null}const we=512*1024,Ee=1024*1024,Ae=512*4;function Te(t){if(!t)return[0,0];const[,e]=t.split("="),s=e.split(", "),[n,o]=s[0].split("-");return[+n,+o||0]}function Ct(t,e=Ae){return t-t%e}function Be(t){return 2**Math.ceil(Math.log(t)/Math.log(2))}const Ce={name:"tweb",version:7,stores:[{name:"session"},{name:"stickerSets"},{name:"users"},{name:"chats"},{name:"dialogs"},{name:"messages"}]},Ie="assets/img/logo_filled_rounded.png",Pe="assets/img/logo_plain.svg";function Ht(t,e,s){const n=s&&new Set(s),o=f=>Object.keys(f).filter(c=>f[c]!==void 0),a=s?f=>o(f).filter(c=>!n.has(c)):o,h=typeof t;return t&&e&&h==="object"&&h===typeof e?a(t).length===a(e).length&&a(t).every(f=>Ht(t[f],e[f],s)):t===e}function Fe(t,e){if(e)for(const s in e)e[s]!==void 0&&(t[s]=e[s]);return t}const tt=class tt{constructor(e){Fe(this,e),R.test&&(this.name+="_test"),this.storageIsAvailable=!0,this.log=nt(["IDB",e.name].join("-")),this.log("constructor"),this.openDatabase(!0),tt.INSTANCES.push(this)}isAvailable(){return this.storageIsAvailable}openDatabase(e=!1){if(this.openDbPromise&&!e)return this.openDbPromise;const s=(h,l)=>{const f=Array.from(h.indexNames);for(const c of f)h.deleteIndex(c);if(l.indexes?.length)for(const c of l.indexes)h.indexNames.contains(c.indexName)||h.createIndex(c.indexName,c.keyPath,c.objectParameters)},n=(h,l)=>{const f=h.createObjectStore(l.name);s(f,l)};try{var o=indexedDB.open(this.name,this.version);if(!o)return Promise.reject()}catch(h){return this.log.error("error opening db",h.message),this.storageIsAvailable=!1,Promise.reject(h)}let a=!1;return setTimeout(()=>{a||o.onerror(et("IDB_CREATE_TIMEOUT"))},3e3),this.openDbPromise=new Promise((h,l)=>{o.onsuccess=f=>{a=!0;const c=o.result;let p=!1;this.log("Opened"),c.onerror=_=>{this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",_),l(_)},c.onclose=_=>{this.log.error("closed:",_),!p&&this.openDatabase()},c.onabort=_=>{this.log.error("abort:",_);const m=_.target;this.openDatabase(p=!0),m.onerror&&m.onerror(_),c.close()},c.onversionchange=_=>{this.log.error("onversionchange, lol?")},h(this.db=c)},o.onerror=f=>{a=!0,this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",f),l(f)},o.onupgradeneeded=f=>{a=!0,this.log.warn("performing idb upgrade from",f.oldVersion,"to",f.newVersion);const c=f.target,p=c.result;this.stores.forEach(_=>{if(!p.objectStoreNames.contains(_.name))n(p,_);else{const g=c.transaction.objectStore(_.name);s(g,_)}})}})}static create(e){return this.INSTANCES.find(s=>s.name===e.name)??new tt(e)}static closeDatabases(e){this.INSTANCES.forEach(s=>{if(e&&e===s)return;const n=s.db;n&&(n.onclose=()=>{},n.close())})}};tt.INSTANCES=[];let mt=tt;class ke{constructor(e,s){this.storeName=s,this.log=nt(["IDB",e.name,s].join("-")),this.idb=mt.create(e)}delete(e,s){const n=Array.isArray(e);return n||(e=[].concat(e)),this.getObjectStore("readwrite",o=>{const a=e.map(h=>o.delete(h));return n?a:a[0]},"",s)}clear(e){return this.getObjectStore("readwrite",s=>s.clear(),"",e)}save(e,s,n){const o=Array.isArray(e);return o||(e=[].concat(e),s=[].concat(s)),this.getObjectStore("readwrite",a=>{const h=e.map((l,f)=>a.put(s[f],l));return o?h:h[0]},"",n)}get(e,s){const n=Array.isArray(e);if(n){if(!e.length)return Promise.resolve([])}else{if(!e)return;e=[].concat(e)}return this.getObjectStore("readonly",o=>{const a=e.map(h=>o.get(h));return n?a:a[0]},"",s)}getObjectStore(e,s,n,o=this.storeName){let a;return n&&(a=performance.now(),this.log(n+": start")),this.idb.openDatabase().then(h=>new Promise((l,f)=>{const c=h.transaction([o],e),p=()=>{clearTimeout(g),f(c.error)},_=()=>{clearTimeout(g),n&&this.log(n+": end",performance.now()-a);const A=I.map(k=>k.result);l(x?A:A[0])};c.onerror=p;const m=e==="readwrite";m&&(c.oncomplete=()=>_());const g=setTimeout(()=>{this.log.error("transaction not finished",c,n)},1e4),v=s(c.objectStore(o)),x=Array.isArray(v),I=x?v:[].concat(v);if(m)return;const P=I.length;let B=P;const T=()=>{c.error||--B||_()};for(let A=0;A<P;++A){const k=I[A];k.onerror=p,k.onsuccess=T}}))}getAll(e){return this.getObjectStore("readonly",s=>s.getAll(),"",e)}}const z=self,ze=location.protocol+"//"+location.hostname+location.pathname.split("/").slice(0,-1).join("/")+"/",Le=11500;let Yt=0,Vt=!0;class De{constructor(e,s,n){this.defaults=n,this.cache={},this.storage=new ke(e,s)}getDefault(e){const s=this.defaults[e];return typeof s=="function"?s():s}get(e){return this.cache.hasOwnProperty(e)?this.cache[e]:this.storage.get(e).then(n=>n,()=>{}).then(n=>this.cache.hasOwnProperty(e)?this.cache[e]:(n??(n=this.getDefault(e)),this.cache[e]=n))}getCached(e){const s=this.get(e);if(s instanceof Promise)throw"no property";return s}async set(e,s){const n=this.cache[e]??this.defaults[e];if(!Ht(n,s)){this.cache[e]=s;try{this.storage.save(e,s)}catch{}}}}const jt={push_mute_until:0,push_lang:{push_message_nopreview:"You have a new message",push_action_mute1d:"Mute for 24H",push_action_settings:"Settings"},push_settings:{}},G=new De(Ce,"session",jt);for(const t in jt)G.get(t);z.addEventListener("push",t=>{const e=t.data.json();U("push",{...e});try{const[s,n,o]=[G.getCached("push_mute_until"),G.getCached("push_settings"),G.getCached("push_lang")],a=Date.now();if(Wt()&&s&&a<s)throw`supress notification because mute for ${Math.ceil((s-a)/6e4)} min`;if(Date.now()-Yt<=Le&&Vt)throw"supress notification because some instance is alive";const l=Oe(e,n,o);t.waitUntil(l)}catch(s){U(s)}});z.addEventListener("notificationclick",t=>{const e=t.notification;U("on notification click",e),e.close();const s=t.action;if(s==="mute1d"&&Wt()){U("[SW] mute for 1d"),G.set("push_mute_until",Date.now()+864e5);return}const n=e.data;if(!n)return;const o=z.clients.matchAll({type:"window"}).then(a=>{n.action=s,V=n;for(let h=0;h<a.length;++h){const l=a[h];if("focus"in l){l.focus(),C.invokeVoid("pushClick",V,l),V=void 0;return}}if(z.clients.openWindow)return Promise.resolve(G.get("push_settings")).then(h=>z.clients.openWindow(h.baseUrl||ze))}).catch(a=>{U.error("Clients.matchAll error",a)});t.waitUntil(o)});z.addEventListener("notificationclose",Re);const vt=new Set;let V;function Re(t){Ne(t.notification)}function Ne(t){vt.delete(t)}function Me(t){for(const s of vt)try{if(t&&s.tag!==t)continue;s.close(),vt.delete(s)}catch{}let e;return"getNotifications"in z.registration?e=z.registration.getNotifications({tag:t}).then(s=>{for(let n=0,o=s.length;n<o;++n)try{s[n].close()}catch{}}).catch(s=>{U.error("Offline register SW error",s)}):e=Promise.resolve(),e}function Wt(){return Pt}function Oe(t,e,s){let n=t.title||"Telegram",o=t.description||"",a;t.custom&&(t.custom.channel_id?a=""+-t.custom.channel_id:t.custom.chat_id?a=""+-t.custom.chat_id:a=t.custom.from_id||""),t.custom.peerId=""+a;let h="peer"+a;const l=a+"_"+t.custom.msg_id;if(it.has(l)){const _="ignoring push";throw U.warn(_,t),it.delete(l),_}e?.nopreview&&(n="Telegram",o=s.push_message_nopreview,h="unknown_peer");const f=[{action:"mute1d",title:s.push_action_mute1d}],c={body:o,icon:Ie,tag:h,data:t,actions:f,badge:Pe,silent:t.custom.silent==="1"};return U("show notify",n,o,t,c),z.registration.showNotification(n,c).catch(_=>{U.error("Show notification promise",_)})}function Ge(t,e){Yt=Date.now(),Vt=t.localNotifications,V&&e&&(C.invokeVoid("pushClick",V,e),V=void 0),t.lang&&G.set("push_lang",t.lang),t.settings&&G.set("push_settings",t.settings)}const it=new Map;function He(t){it.set(t,Date.now())}setInterval(()=>{const t=Date.now();it.forEach((e,s)=>{t-e>3e4&&it.delete(s)})},30*6e4);const Ye=Date.now()%Math.random()*1e8|0;function _t(t,e){const s=t.indexOf(e);return(s===-1?void 0:t.splice(s,1))?.[0]}function Ve(t,e){const s=t.findIndex(e);return s!==-1?t.splice(s,1)[0]:void 0}class je{constructor(e){this._constructor(e)}_constructor(e){this.reuseResults=e,this.listeners={},this.listenerResults={}}addEventListener(e,s,n){var o;if(((o=this.listeners)[e]??(o[e]=[])).push({callback:s,options:n}),this.listenerResults.hasOwnProperty(e)&&(s(...this.listenerResults[e]),n?.once)){this.listeners[e].pop();return}}addMultipleEventsListeners(e){for(const s in e)this.addEventListener(s,e[s])}removeEventListener(e,s,n){this.listeners[e]&&Ve(this.listeners[e],o=>o.callback===s)}invokeListenerCallback(e,s,...n){let o,a;try{o=s.callback(...n)}catch(h){a=h}if(s.options?.once&&this.removeEventListener(e,s.callback),a)throw a;return o}_dispatchEvent(e,s,...n){this.reuseResults&&(this.listenerResults[e]=n);const o=s&&[],a=this.listeners[e];return a&&a.slice().forEach(l=>{if(a.findIndex(p=>p.callback===l.callback)===-1)return;const c=this.invokeListenerCallback(e,l,...n);o&&o.push(c)}),o}dispatchResultableEvent(e,...s){return this._dispatchEvent(e,!0,...s)}dispatchEvent(e,...s){this._dispatchEvent(e,!1,...s)}cleanup(){this.listeners={},this.listenerResults={}}}const We=!0;class qe extends je{constructor(e){super(!1),this.logSuffix=e,this.onMessage=s=>{const n=s.data,o=s.source||s.currentTarget;this.processTaskMap[n.type](n,o,s)},this.processResultTask=s=>{const{taskId:n,result:o,error:a}=s.payload,h=this.awaiting[n];h&&(this.debug&&this.log.debug("done",h.taskType,o,a),"error"in s.payload?h.reject(a):h.resolve(o),delete this.awaiting[n])},this.processAckTask=s=>{const n=s.payload,o=this.awaiting[n.taskId];if(!o)return;const a=o.resolve,h={cached:n.cached,result:n.cached?"result"in n?Promise.resolve(n.result):Promise.reject(n.error):new Promise((l,f)=>{o.resolve=l,o.reject=f})};a(h),n.cached&&delete this.awaiting[n.taskId]},this.processPingTask=(s,n,o)=>{this.pushTask(this.createTask("pong",void 0),o.source)},this.processPongTask=(s,n,o)=>{const a=this.pingResolves.get(n);a&&(this.pingResolves.delete(n),a())},this.processCloseTask=(s,n,o)=>{this.detachPort(n)},this.processBatchTask=(s,n,o)=>{const a={data:o.data,source:o.source,currentTarget:o.currentTarget};s.payload.forEach(h=>{a.data=h,this.onMessage(a)})},this.processLockTask=(s,n,o)=>{const a=s.payload;this.requestedLocks.has(a)||(this.requestedLocks.set(a,n),navigator.locks.request(a,()=>{this.processCloseTask(void 0,n,void 0),this.requestedLocks.delete(a)}))},this.processInvokeTask=async(s,n,o)=>{const a=s.id,h=s.payload;let l,f,c;h.void||(l={taskId:a},f=this.createTask("result",l)),h.withAck&&(c=this.createTask("ack",{taskId:a,cached:!0}));let p;try{const _=this.listeners[h.type];if(!_?.length)throw new Error("no listener");const m=_[0];let g=this.invokeListenerCallback(h.type,m,h.payload,n,o);if(h.void)return;if(p=g instanceof Promise,c){const v=!p;if(c.payload.cached=v,v&&(c.payload.result=g),this.pushTask(c,n),v)return}p&&(g=await g),l.result=g}catch(_){if(this.log.error("worker task error:",_,s),h.void)return;if(c&&c.payload.cached){c.payload.error=_,this.pushTask(c,n);return}l.error=_}this.pushTask(f,n)},this.listenPorts=[],this.sendPorts=[],this.pingResolves=new Map,this.taskId=0,this.awaiting={},this.pending=new Map,this.log=nt("MP"+(e?"-"+e:"")),this.debug=Ut,this.heldLocks=new Map,this.requestedLocks=new Map,this.processTaskMap={result:this.processResultTask,ack:this.processAckTask,invoke:this.processInvokeTask,ping:this.processPingTask,pong:this.processPongTask,close:this.processCloseTask,lock:this.processLockTask,batch:this.processBatchTask}}setOnPortDisconnect(e){this.onPortDisconnect=e}attachPort(e){this.attachListenPort(e),this.attachSendPort(e)}attachListenPort(e){this.listenPorts.push(e),e.addEventListener("message",this.onMessage)}attachSendPort(e){if(this.log.warn("attaching send port"),e.start?.(),this.sendPorts.push(e),typeof window<"u"&&We)if("locks"in navigator){const s=["lock",Ye,this.logSuffix||"",Math.random()*2147483647|0].join("-");this.log.warn("created lock",s);const n=new Promise(o=>this.heldLocks.set(e,{resolve:o,id:s})).then(()=>this.heldLocks.delete(e));navigator.locks.request(s,()=>(this.resendLockTask(e),n))}else window.addEventListener("beforeunload",()=>{const s=this.createTask("close",void 0);this.postMessage(void 0,s)});this.releasePending()}resendLockTask(e){const s=this.heldLocks.get(e);s&&this.pushTask(this.createTask("lock",s.id),e)}detachPort(e){this.log.warn("disconnecting port"),_t(this.listenPorts,e),_t(this.sendPorts,e),e.removeEventListener?.("message",this.onMessage),e.close?.(),this.onPortDisconnect?.(e),this.heldLocks.get(e)?.resolve();const n=et("PORT_DISCONNECTED");for(const o in this.awaiting){const a=this.awaiting[o];a.port===e&&(a.reject(n),delete this.awaiting[o])}}postMessage(e,s){(Array.isArray(e)?e:e?[e]:this.sendPorts).forEach(o=>{o.postMessage(s,s.transfer)})}async releasePending(){this.releasingPending||(this.releasingPending=!0,await Promise.resolve(),this.debug&&this.log.debug("releasing tasks, length:",this.pending.size),this.pending.forEach((e,s)=>{let n=e;{let a;n=[],e.forEach(h=>{h.transfer?(a=void 0,n.push(h)):(a||(a=this.createTask("batch",[]),n.push(a)),a.payload.push(h))})}const o=s?[s]:this.sendPorts;o.length&&(n.forEach(a=>{try{this.postMessage(o,a)}catch(h){this.log.error("postMessage error:",h,a,o)}}),this.pending.delete(s))}),this.debug&&this.log.debug("released tasks"),this.releasingPending=!1)}createTask(e,s,n){return{type:e,payload:s,id:this.taskId++,transfer:n}}createInvokeTask(e,s,n,o,a){return this.createTask("invoke",{type:e,payload:s,withAck:n,void:o},a)}pushTask(e,s){let n=this.pending.get(s);n||this.pending.set(s,n=[]),n.push(e),this.releasePending()}invokeVoid(e,s,n,o){const a=this.createInvokeTask(e,s,void 0,!0,o);this.pushTask(a,n)}invoke(e,s,n,o,a){this.debug&&this.log.debug("start",e,s);let h;const l=new Promise((f,c)=>{h=this.createInvokeTask(e,s,n,void 0,a),this.awaiting[h.id]={resolve:f,reject:c,taskType:e,port:o},this.pushTask(h,o)});if(se){l.finally(()=>{clearInterval(f)});const f=O.setInterval(()=>{this.log.error("task still has no result",h,o)},6e4)}return l}invokeExceptSource(e,s,n){const o=this.sendPorts.slice();_t(o,n),o.forEach(a=>{this.invokeVoid(e,s,a)})}}class Ke extends qe{constructor(){super("SERVICE"),wt&&(wt.serviceMessagePort=this)}}function Xe(t,e,s){const n=(o,a)=>{t.attachListenPort(o),a&&t.attachSendPort(a),e?.(o)};t.setOnPortDisconnect(s),typeof SharedWorkerGlobalScope<"u"?O.addEventListener("connect",o=>n(o.source,o.source)):typeof ServiceWorkerGlobalScope<"u"?n(O,null):n(O,O)}const F=new Map,gt=et("UNKNOWN"),$e=!1;self.downloadMap=F;const Ze={download:t=>{const{id:e}=t;if(F.has(e))return Promise.reject(gt);const s=new CountQueuingStrategy({highWaterMark:1}),n=lt();n.then(()=>{setTimeout(()=>{F.delete(e)},5e3)},()=>{F.delete(e)});let o;const a=new ReadableStream({start:l=>{o=l},cancel:l=>{n.reject(gt)}},s),h={...t,readableStream:a,promise:n,controller:o};return F.set(e,h),n.catch(()=>{throw gt})},downloadChunk:({id:t,chunk:e})=>{const s=F.get(t);return s?s.controller.enqueue(e):Promise.reject()},downloadFinalize:t=>{const e=F.get(t);return e?(e.promise.resolve(),e.controller.close()):Promise.reject()},downloadCancel:t=>{const e=F.get(t);if(e)return e.promise.reject(),e.controller.error()}};function Je(t){return t.addMultipleEventsListeners(Ze),{onDownloadFetch:Qe,onClosedWindows:ti}}function Qe(t,e){const s=Rt(100).then(()=>{const n=F.get(e);if(!n||n.used&&!$e)return;n.used=!0;const o=n.readableStream;return new Response(o,{headers:n.headers})});t.respondWith(s)}function ti(){if(F.size)for(const[t,e]of F)e.controller.error()}const Q={};function ei(t){return{files:t.getAll("files"),title:t.get("title"),text:t.get("text"),url:t.get("url")}}async function ii(t,e){try{U("share data",t);const s=ei(t);(Q[e]??(Q[e]=[])).push(s)}catch(s){U.warn("something wrong with the data",s)}}function si(t){const e=Q[t.id];e&&(delete Q[t.id],U("releasing share events to client:",t.id,"length:",e.length),e.forEach(s=>{C.invokeVoid("share",s,t)}))}function ni(t,e){const s=t.request.formData().then(n=>(ii(n,t.resultingClientId),Response.redirect("..")));t.respondWith(s)}var u=function(){var t=new Date,e=4,s=3,n=2,o=1,a=e,h={setLogLevel:function(l){l==this.debug?a=o:l==this.info?a=n:l==this.warn?a=s:(l==this.error,a=e)},debug:function(l,f){console.debug===void 0&&(console.debug=console.log),o>=a&&console.debug("["+u.getDurationString(new Date-t,1e3)+"]","["+l+"]",f)},log:function(l,f){this.debug(l.msg)},info:function(l,f){n>=a&&console.info("["+u.getDurationString(new Date-t,1e3)+"]","["+l+"]",f)},warn:function(l,f){s>=a&&console.warn("["+u.getDurationString(new Date-t,1e3)+"]","["+l+"]",f)},error:function(l,f){e>=a&&console.error("["+u.getDurationString(new Date-t,1e3)+"]","["+l+"]",f)}};return h}();u.getDurationString=function(t,e){var s;function n(c,p){for(var _=""+c,m=_.split(".");m[0].length<p;)m[0]="0"+m[0];return m.join(".")}t<0?(s=!0,t=-t):s=!1;var o=e||1,a=t/o,h=Math.floor(a/3600);a-=h*3600;var l=Math.floor(a/60);a-=l*60;var f=a*1e3;return a=Math.floor(a),f-=a*1e3,f=Math.floor(f),(s?"-":"")+h+":"+n(l,2)+":"+n(a,2)+"."+n(f,3)};u.printRanges=function(t){var e=t.length;if(e>0){for(var s="",n=0;n<e;n++)n>0&&(s+=","),s+="["+u.getDurationString(t.start(n))+","+u.getDurationString(t.end(n))+"]";return s}else return"(empty)"};typeof w<"u"&&(w.Log=u);var b=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};b.prototype.getPosition=function(){return this.position};b.prototype.getEndPosition=function(){return this.buffer.byteLength};b.prototype.getLength=function(){return this.buffer.byteLength};b.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0};b.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()};b.prototype.readAnyInt=function(t,e){var s=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?s=this.dataview.getInt8(this.position):s=this.dataview.getUint8(this.position);break;case 2:e?s=this.dataview.getInt16(this.position):s=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";s=this.dataview.getUint8(this.position)<<16,s|=this.dataview.getUint8(this.position+1)<<8,s|=this.dataview.getUint8(this.position+2);break;case 4:e?s=this.dataview.getInt32(this.position):s=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";s=this.dataview.getUint32(this.position)<<32,s|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,s}else throw"Not enough bytes in buffer"};b.prototype.readUint8=function(){return this.readAnyInt(1,!1)};b.prototype.readUint16=function(){return this.readAnyInt(2,!1)};b.prototype.readUint24=function(){return this.readAnyInt(3,!1)};b.prototype.readUint32=function(){return this.readAnyInt(4,!1)};b.prototype.readUint64=function(){return this.readAnyInt(8,!1)};b.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",s=0;s<t;s++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"};b.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)};b.prototype.readInt8=function(){return this.readAnyInt(1,!0)};b.prototype.readInt16=function(){return this.readAnyInt(2,!0)};b.prototype.readInt32=function(){return this.readAnyInt(4,!0)};b.prototype.readInt64=function(){return this.readAnyInt(8,!1)};b.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),s=0;s<t;s++)e[s]=this.readUint8();return e};b.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),s=0;s<t;s++)e[s]=this.readInt16();return e};b.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),s=0;s<t;s++)e[s]=this.readUint16();return e};b.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),s=0;s<t;s++)e[s]=this.readUint32();return e};b.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),s=0;s<t;s++)e[s]=this.readInt32();return e};typeof w<"u"&&(w.MP4BoxStream=b);var d=function(t,e,s){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=s??d.LITTLE_ENDIAN};d.prototype={};d.prototype.getPosition=function(){return this.position};d.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,s=this._buffer.byteLength;if(e<=s){e>this._byteLength&&(this._byteLength=e);return}for(s<1&&(s=1);e>s;)s*=2;var n=new ArrayBuffer(s),o=new Uint8Array(this._buffer),a=new Uint8Array(n,0,o.length);a.set(o),this.buffer=n,this._byteLength=e}};d.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),s=new Uint8Array(this._buffer,0,e.length);e.set(s),this.buffer=t}};d.BIG_ENDIAN=!1;d.LITTLE_ENDIAN=!0;d.prototype._byteLength=0;Object.defineProperty(d.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}});Object.defineProperty(d.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}});Object.defineProperty(d.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}});Object.defineProperty(d.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}});d.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e};d.prototype.isEof=function(){return this.position>=this._byteLength};d.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e};d.prototype.readInt32Array=function(t,e){t=t??this.byteLength-this.position/4;var s=new Int32Array(t);return d.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),d.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s};d.prototype.readInt16Array=function(t,e){t=t??this.byteLength-this.position/2;var s=new Int16Array(t);return d.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),d.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s};d.prototype.readInt8Array=function(t){t=t??this.byteLength-this.position;var e=new Int8Array(t);return d.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e};d.prototype.readUint32Array=function(t,e){t=t??this.byteLength-this.position/4;var s=new Uint32Array(t);return d.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),d.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s};d.prototype.readUint16Array=function(t,e){t=t??this.byteLength-this.position/2;var s=new Uint16Array(t);return d.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),d.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s};d.prototype.readUint8Array=function(t){t=t??this.byteLength-this.position;var e=new Uint8Array(t);return d.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e};d.prototype.readFloat64Array=function(t,e){t=t??this.byteLength-this.position/8;var s=new Float64Array(t);return d.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),d.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s};d.prototype.readFloat32Array=function(t,e){t=t??this.byteLength-this.position/4;var s=new Float32Array(t);return d.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),d.arrayToNative(s,e??this.endianness),this.position+=s.byteLength,s};d.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t??this.endianness);return this.position+=4,e};d.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t??this.endianness);return this.position+=2,e};d.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t};d.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t??this.endianness);return this.position+=4,e};d.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t??this.endianness);return this.position+=2,e};d.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t};d.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t??this.endianness);return this.position+=4,e};d.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t??this.endianness);return this.position+=8,e};d.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0;d.memcpy=function(t,e,s,n,o){var a=new Uint8Array(t,e,o),h=new Uint8Array(s,n,o);a.set(h)};d.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)};d.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)};d.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s=0;s<t.byteLength;s+=t.BYTES_PER_ELEMENT)for(var n=s+t.BYTES_PER_ELEMENT-1,o=s;n>o;n--,o++){var a=e[o];e[o]=e[n],e[n]=a}return t};d.prototype.failurePosition=0;String.fromCharCodeUint8=function(t){for(var e=[],s=0;s<t.length;s++)e[s]=t[s];return String.fromCharCode.apply(null,e)};d.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t??this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))};d.prototype.readCString=function(t){var e=this.byteLength-this.position,s=new Uint8Array(this._buffer,this._byteOffset+this.position),n=e;t!=null&&(n=Math.min(t,e));for(var o=0;o<n&&s[o]!==0;o++);var a=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(o)]);return t!=null?this.position+=n-o:o!=e&&(this.position+=1),a};var H=Math.pow(2,32);d.prototype.readInt64=function(){return this.readInt32()*H+this.readUint32()};d.prototype.readUint64=function(){return this.readUint32()*H+this.readUint32()};d.prototype.readInt64=function(){return this.readUint32()*H+this.readUint32()};d.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()};typeof w<"u"&&(w.DataStream=d);d.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var s=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.setAttribute("href",s),n.setAttribute("download",t),n.setAttribute("target","_self"),n.click(),window.URL.revokeObjectURL(s)}else throw"DataStream.save: Can't create object URL."};d.prototype._dynamicSize=!0;Object.defineProperty(d.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}});d.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),s=new Uint8Array(e),n=new Uint8Array(this._buffer,t,s.length);s.set(n),this.buffer=e,this.position-=t};d.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeInt32(t[s],e)};d.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeInt16(t[s],e)};d.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])};d.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeUint32(t[s],e)};d.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeUint16(t[s],e)};d.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])};d.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeFloat64(t[s],e)};d.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)d.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeFloat32(t[s],e)};d.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e??this.endianness),this.position+=4};d.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e??this.endianness),this.position+=2};d.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1};d.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e??this.endianness),this.position+=4};d.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e??this.endianness),this.position+=2};d.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1};d.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e??this.endianness),this.position+=4};d.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e??this.endianness),this.position+=8};d.prototype.writeUCS2String=function(t,e,s){s==null&&(s=t.length);for(var n=0;n<t.length&&n<s;n++)this.writeUint16(t.charCodeAt(n),e);for(;n<s;n++)this.writeUint16(0)};d.prototype.writeString=function(t,e,s){var n=0;if(e==null||e=="ASCII")if(s!=null){var o=Math.min(t.length,s);for(n=0;n<o;n++)this.writeUint8(t.charCodeAt(n));for(;n<s;n++)this.writeUint8(0)}else for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,s)))};d.prototype.writeCString=function(t,e){var s=0;if(e!=null){var n=Math.min(t.length,e);for(s=0;s<n;s++)this.writeUint8(t.charCodeAt(s));for(;s<e;s++)this.writeUint8(0)}else{for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));this.writeUint8(0)}};d.prototype.writeStruct=function(t,e){for(var s=0;s<t.length;s+=2){var n=t[s+1];this.writeType(n,e[t[s]],e)}};d.prototype.writeType=function(t,e,s){var n;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,s);var o=null,a="ASCII",h=this.position;switch(typeof t=="string"&&/:/.test(t)&&(n=t.split(":"),t=n[0],o=parseInt(n[1])),typeof t=="string"&&/,/.test(t)&&(n=t.split(","),t=n[0],a=parseInt(n[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,d.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,d.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,d.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,d.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,d.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,d.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,d.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,d.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,d.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,d.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,d.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,d.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,o);break;case"string":this.writeString(e,a,o);break;case"u16string":this.writeUCS2String(e,this.endianness,o);break;case"u16stringle":this.writeUCS2String(e,d.LITTLE_ENDIAN,o);break;case"u16stringbe":this.writeUCS2String(e,d.BIG_ENDIAN,o);break;default:if(t.length==3){for(var l=t[1],f=0;f<e.length;f++)this.writeType(l,e[f]);break}else{this.writeStruct(t,e);break}}o!=null&&(this.position=h,this._realloc(o),this.position=h+o)};d.prototype.writeUint64=function(t){var e=Math.floor(t/H);this.writeUint32(e),this.writeUint32(t&4294967295)};d.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)};d.prototype.adjustUint32=function(t,e){var s=this.position;this.seek(t),this.writeUint32(e),this.seek(s)};d.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var s=new Int32Array(this._buffer,this.byteOffset+this.position,t);return d.arrayToNative(s,e??this.endianness),this.position+=t*4,s};d.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var s=new Int16Array(this._buffer,this.byteOffset+this.position,t);return d.arrayToNative(s,e??this.endianness),this.position+=t*2,s};d.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e};d.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var s=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return d.arrayToNative(s,e??this.endianness),this.position+=t*4,s};d.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var s=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return d.arrayToNative(s,e??this.endianness),this.position+=t*2,s};d.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var s=new Float64Array(this._buffer,this.byteOffset+this.position,t);return d.arrayToNative(s,e??this.endianness),this.position+=t*8,s};d.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var s=new Float32Array(this._buffer,this.byteOffset+this.position,t);return d.arrayToNative(s,e??this.endianness),this.position+=t*4,s};var E=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};E.prototype=new d(new ArrayBuffer,0,d.BIG_ENDIAN);E.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,u.debug("MultiBufferStream","Stream ready for parsing"),!0):(u.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(u.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)};ArrayBuffer.concat=function(t,e){u.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var s=new Uint8Array(t.byteLength+e.byteLength);return s.set(new Uint8Array(t),0),s.set(new Uint8Array(e),t.byteLength),s.buffer};E.prototype.reduceBuffer=function(t,e,s){var n;return n=new Uint8Array(s),n.set(new Uint8Array(t,e,s)),n.buffer.fileStart=t.fileStart+e,n.buffer.usedBytes=0,n.buffer};E.prototype.insertBuffer=function(t){for(var e=!0,s=0;s<this.buffers.length;s++){var n=this.buffers[s];if(t.fileStart<=n.fileStart){if(t.fileStart===n.fileStart)if(t.byteLength>n.byteLength){this.buffers.splice(s,1),s--;continue}else u.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=n.fileStart||(t=this.reduceBuffer(t,0,n.fileStart-t.fileStart)),u.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(s,0,t),s===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<n.fileStart+n.byteLength){var o=n.fileStart+n.byteLength-t.fileStart,a=t.byteLength-o;if(a>0)t=this.reduceBuffer(t,o,a);else{e=!1;break}}}e&&(u.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),s===0&&(this.buffer=t))};E.prototype.logBufferLevel=function(t){var e,s,n,o,a=[],h,l="";for(n=0,o=0,e=0;e<this.buffers.length;e++)s=this.buffers[e],e===0?(h={},a.push(h),h.start=s.fileStart,h.end=s.fileStart+s.byteLength,l+="["+h.start+"-"):h.end===s.fileStart?h.end=s.fileStart+s.byteLength:(h={},h.start=s.fileStart,l+=a[a.length-1].end-1+"], ["+h.start+"-",h.end=s.fileStart+s.byteLength,a.push(h)),n+=s.usedBytes,o+=s.byteLength;a.length>0&&(l+=h.end-1+"]");var f=t?u.info:u.debug;this.buffers.length===0?f("MultiBufferStream","No more buffer in memory"):f("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+n+"/"+o+" bytes), continuous ranges: "+l)};E.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(u.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)};E.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,s=this.buffer.usedBytes,n=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=s,this.buffer.fileStart=n,u.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1};E.prototype.findPosition=function(t,e,s){var n,o=null,a=-1;for(t===!0?n=0:n=this.bufferIndex;n<this.buffers.length&&(o=this.buffers[n],o.fileStart<=e);){a=n,s&&(o.fileStart+o.byteLength<=e?o.usedBytes=o.byteLength:o.usedBytes=e-o.fileStart,this.logBufferLevel());n++}return a!==-1?(o=this.buffers[a],o.fileStart+o.byteLength>=e?(u.debug("MultiBufferStream","Found position in existing buffer #"+a),a):-1):-1};E.prototype.findEndContiguousBuf=function(t){var e,s,n,o=t!==void 0?t:this.bufferIndex;if(s=this.buffers[o],this.buffers.length>o+1)for(e=o+1;e<this.buffers.length&&(n=this.buffers[e],n.fileStart===s.fileStart+s.byteLength);e++)s=n;return s.fileStart+s.byteLength};E.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t};E.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()};E.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()};E.prototype.seek=function(t,e,s){var n;return n=this.findPosition(e,t,s),n!==-1?(this.buffer=this.buffers[n],this.bufferIndex=n,this.position=t-this.buffer.fileStart,u.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(u.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)};E.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position};E.prototype.getLength=function(){return this.byteLength};E.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength};typeof w<"u"&&(w.MultiBufferStream=E);var St=function(){var t=3,e=4,s=5,n=6,o=[];o[t]="ES_Descriptor",o[e]="DecoderConfigDescriptor",o[s]="DecoderSpecificInfo",o[n]="SLConfigDescriptor",this.getDescriptorName=function(l){return o[l]};var a=this,h={};return this.parseOneDescriptor=function(l){var f=0,c,p,_;for(c=l.readUint8(),_=l.readUint8();_&128;)f=(_&127)<<7,_=l.readUint8();return f+=_&127,u.debug("MPEG4DescriptorParser","Found "+(o[c]||"Descriptor "+c)+", size "+f+" at position "+l.getPosition()),o[c]?p=new h[o[c]](f):p=new h.Descriptor(f),p.parse(l),p},h.Descriptor=function(l,f){this.tag=l,this.size=f,this.descs=[]},h.Descriptor.prototype.parse=function(l){this.data=l.readUint8Array(this.size)},h.Descriptor.prototype.findDescriptor=function(l){for(var f=0;f<this.descs.length;f++)if(this.descs[f].tag==l)return this.descs[f];return null},h.Descriptor.prototype.parseRemainingDescriptors=function(l){for(var f=l.position;l.position<f+this.size;){var c=a.parseOneDescriptor(l);this.descs.push(c)}},h.ES_Descriptor=function(l){h.Descriptor.call(this,t,l)},h.ES_Descriptor.prototype=new h.Descriptor,h.ES_Descriptor.prototype.parse=function(l){if(this.ES_ID=l.readUint16(),this.flags=l.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=l.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var f=l.readUint8();this.URL=l.readString(f),this.size-=f+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=l.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(l)},h.ES_Descriptor.prototype.getOTI=function(l){var f=this.findDescriptor(e);return f?f.oti:0},h.ES_Descriptor.prototype.getAudioConfig=function(l){var f=this.findDescriptor(e);if(!f)return null;var c=f.findDescriptor(s);if(c&&c.data){var p=(c.data[0]&248)>>3;return p===31&&c.data.length>=2&&(p=32+((c.data[0]&7)<<3)+((c.data[1]&224)>>5)),p}else return null},h.DecoderConfigDescriptor=function(l){h.Descriptor.call(this,e,l)},h.DecoderConfigDescriptor.prototype=new h.Descriptor,h.DecoderConfigDescriptor.prototype.parse=function(l){this.oti=l.readUint8(),this.streamType=l.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=l.readUint24(),this.maxBitrate=l.readUint32(),this.avgBitrate=l.readUint32(),this.size-=13,this.parseRemainingDescriptors(l)},h.DecoderSpecificInfo=function(l){h.Descriptor.call(this,s,l)},h.DecoderSpecificInfo.prototype=new h.Descriptor,h.SLConfigDescriptor=function(l){h.Descriptor.call(this,n,l)},h.SLConfigDescriptor.prototype=new h.Descriptor,this};typeof w<"u"&&(w.MPEG4DescriptorParser=St);var r={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){r.FullBox.prototype=new r.Box,r.ContainerBox.prototype=new r.Box,r.SampleEntry.prototype=new r.Box,r.TrackGroupTypeBox.prototype=new r.FullBox,r.BASIC_BOXES.forEach(function(t){r.createBoxCtor(t)}),r.FULL_BOXES.forEach(function(t){r.createFullBoxCtor(t)}),r.CONTAINER_BOXES.forEach(function(t){r.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,s){this.type=t,this.size=e,this.uuid=s},FullBox:function(t,e,s){r.Box.call(this,t,e,s),this.flags=0,this.version=0},ContainerBox:function(t,e,s){r.Box.call(this,t,e,s),this.boxes=[]},SampleEntry:function(t,e,s,n){r.ContainerBox.call(this,t,e),this.hdr_size=s,this.start=n},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){r.FullBox.call(this,t,e)},createBoxCtor:function(t,e){r.boxCodes.push(t),r[t+"Box"]=function(s){r.Box.call(this,t,s)},r[t+"Box"].prototype=new r.Box,e&&(r[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){r[t+"Box"]=function(s){r.FullBox.call(this,t,s)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(s){this.parseFullHeader(s),e&&e.call(this,s)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,s=0;s<e;s++)this[t[s]+"s"]=[]}},createContainerBoxCtor:function(t,e,s){r[t+"Box"]=function(n){r.ContainerBox.call(this,t,n),r.addSubBoxArrays.call(this,s)},r[t+"Box"].prototype=new r.ContainerBox,e&&(r[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,s){r.sampleEntryCodes[t]=[],r[t+"SampleEntry"]=function(n,o){r.SampleEntry.call(this,n,o),r.addSubBoxArrays.call(this,s)},r[t+"SampleEntry"].prototype=new r.SampleEntry,e&&(r[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,s,n){r.sampleEntryCodes[t].push(e),r[e+"SampleEntry"]=function(o){r[t+"SampleEntry"].call(this,e,o),r.addSubBoxArrays.call(this,n)},r[e+"SampleEntry"].prototype=new r[t+"SampleEntry"],s&&(r[e+"SampleEntry"].prototype.parse=s)},createEncryptedSampleEntryCtor:function(t,e,s){r.createSampleEntryCtor.call(this,t,e,s,["sinf"])},createSampleGroupCtor:function(t,e){r[t+"SampleGroupEntry"]=function(s){r.SampleGroupEntry.call(this,t,s)},r[t+"SampleGroupEntry"].prototype=new r.SampleGroupEntry,e&&(r[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){r[t+"TrackGroupTypeBox"]=function(s){r.TrackGroupTypeBox.call(this,t,s)},r[t+"TrackGroupTypeBox"].prototype=new r.TrackGroupTypeBox,e&&(r[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,s,n){r.UUIDs.push(t),r.UUIDBoxes[t]=function(o){e?r.FullBox.call(this,"uuid",o,t):s?r.ContainerBox.call(this,"uuid",o,t):r.Box.call(this,"uuid",o,t)},r.UUIDBoxes[t].prototype=e?new r.FullBox:s?new r.ContainerBox:new r.Box,n&&(e?r.UUIDBoxes[t].prototype.parse=function(o){this.parseFullHeader(o),n&&n.call(this,o)}:r.UUIDBoxes[t].prototype.parse=n)}};r.initialize();r.TKHD_FLAG_ENABLED=1;r.TKHD_FLAG_IN_MOVIE=2;r.TKHD_FLAG_IN_PREVIEW=4;r.TFHD_FLAG_BASE_DATA_OFFSET=1;r.TFHD_FLAG_SAMPLE_DESC=2;r.TFHD_FLAG_SAMPLE_DUR=8;r.TFHD_FLAG_SAMPLE_SIZE=16;r.TFHD_FLAG_SAMPLE_FLAGS=32;r.TFHD_FLAG_DUR_EMPTY=65536;r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072;r.TRUN_FLAGS_DATA_OFFSET=1;r.TRUN_FLAGS_FIRST_FLAG=4;r.TRUN_FLAGS_DURATION=256;r.TRUN_FLAGS_SIZE=512;r.TRUN_FLAGS_FLAGS=1024;r.TRUN_FLAGS_CTS_OFFSET=2048;r.Box.prototype.add=function(t){return this.addBox(new r[t+"Box"])};r.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t};r.Box.prototype.set=function(t,e){return this[t]=e,this};r.Box.prototype.addEntry=function(t,e){var s=e||"entries";return this[s]||(this[s]=[]),this[s].push(t),this};typeof w<"u"&&(w.BoxParser=r);r.parseUUID=function(t){return r.parseHex16(t)};r.parseHex16=function(t){for(var e="",s=0;s<16;s++){var n=t.readUint8().toString(16);e+=n.length===1?"0"+n:n}return e};r.parseOneBox=function(t,e,s){var n,o=t.getPosition(),a=0,h,l;if(t.getEndPosition()-o<8)return u.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:r.ERR_NOT_ENOUGH_DATA};if(s&&s<8)return u.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:r.ERR_NOT_ENOUGH_DATA};var f=t.readUint32(),c=t.readString(4),p=c;if(u.debug("BoxParser","Found box of type '"+c+"' and size "+f+" at position "+o),a=8,c=="uuid"){if(t.getEndPosition()-t.getPosition()<16||s-a<16)return t.seek(o),u.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:r.ERR_NOT_ENOUGH_DATA};l=r.parseUUID(t),a+=16,p=l}if(f==1){if(t.getEndPosition()-t.getPosition()<8||s&&s-a<8)return t.seek(o),u.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+c+'" box'),{code:r.ERR_NOT_ENOUGH_DATA};f=t.readUint64(),a+=8}else if(f===0){if(s)f=s;else if(c!=="mdat")return u.error("BoxParser","Unlimited box size not supported for type: '"+c+"'"),n=new r.Box(c,f),{code:r.OK,box:n,size:n.size}}return f!==0&&f<a?(u.error("BoxParser","Box of type "+c+" has an invalid size "+f+" (too small to be a box)"),{code:r.ERR_NOT_ENOUGH_DATA,type:c,size:f,hdr_size:a,start:o}):f!==0&&s&&f>s?(u.error("BoxParser","Box of type '"+c+"' has a size "+f+" greater than its container size "+s),{code:r.ERR_NOT_ENOUGH_DATA,type:c,size:f,hdr_size:a,start:o}):f!==0&&o+f>t.getEndPosition()?(t.seek(o),u.info("BoxParser","Not enough data in stream to parse the entire '"+c+"' box"),{code:r.ERR_NOT_ENOUGH_DATA,type:c,size:f,hdr_size:a,start:o}):e?{code:r.OK,type:c,size:f,hdr_size:a,start:o}:(r[c+"Box"]?n=new r[c+"Box"](f):c!=="uuid"?(u.warn("BoxParser","Unknown box type: '"+c+"'"),n=new r.Box(c,f),n.has_unparsed_data=!0):r.UUIDBoxes[l]?n=new r.UUIDBoxes[l](f):(u.warn("BoxParser","Unknown uuid type: '"+l+"'"),n=new r.Box(c,f),n.uuid=l,n.has_unparsed_data=!0),n.hdr_size=a,n.start=o,n.write===r.Box.prototype.write&&n.type!=="mdat"&&(u.info("BoxParser","'"+p+"' box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),h=t.getPosition()-(n.start+n.size),h<0?(u.warn("BoxParser","Parsing of box '"+p+"' did not read the entire indicated box data size (missing "+-h+" bytes), seeking forward"),t.seek(n.start+n.size)):h>0&&(u.error("BoxParser","Parsing of box '"+p+"' read "+h+" more bytes than the indicated box data size, seeking backwards"),n.size!==0&&t.seek(n.start+n.size)),{code:r.OK,box:n,size:n.size})};r.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)};r.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size};r.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size};r.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4};r.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)};r.ContainerBox.prototype.parse=function(t){for(var e,s;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)if(s=e.box,this.boxes.push(s),this.subBoxNames&&this.subBoxNames.indexOf(s.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(s.type)]+"s"].push(s);else{var n=s.type!=="uuid"?s.type:s.uuid;this[n]?u.warn("Box of type "+n+" already stored in field of this type"):this[n]=s}else return};r.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)};r.SAMPLE_ENTRY_TYPE_VISUAL="Visual";r.SAMPLE_ENTRY_TYPE_AUDIO="Audio";r.SAMPLE_ENTRY_TYPE_HINT="Hint";r.SAMPLE_ENTRY_TYPE_METADATA="Metadata";r.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle";r.SAMPLE_ENTRY_TYPE_SYSTEM="System";r.SAMPLE_ENTRY_TYPE_TEXT="Text";r.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8};r.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)};r.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size};r.SampleEntry.prototype.parseFooter=function(t){r.ContainerBox.prototype.parse.call(this,t)};r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_HINT);r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA);r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE);r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM);r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT);r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)});r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc2");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc3");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc4");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"av01");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dav1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hev1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vp08");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vp09");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avs3");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"uncv");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"Opus");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mha1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mha2");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1");r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2");r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"encv");r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"enca");r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu");r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM,"encs");r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT,"enct");r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"encm");r.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,s=((e&1)+1)*16;this.layer_size=[];for(var n=0;n<3;n++)s==16?this.layer_size[n]=t.readUint16():this.layer_size[n]=t.readUint32()});r.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()});r.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)});r.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){u.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){u.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){u.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){u.error("av1C reserved_2 parsing problem");return}var s=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(s)});r.createBoxCtor("avcC",function(t){var e,s;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,s=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),s-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),s--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),s-=2+this.PPS[e].length;s>0&&(this.ext=t.readUint8Array(s))});r.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()});r.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()});r.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())});r.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()});r.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()});r.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())});r.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())});r.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint32(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}});r.createFullBoxCtor("co64",function(t){var e,s;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(s=0;s<e;s++)this.chunk_offsets.push(t.readUint64())});r.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()});r.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))});r.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()});r.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())});r.createFullBoxCtor("ctts",function(t){var e,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(s=0;s<e;s++){this.sample_counts.push(t.readUint32());var n=t.readInt32();n<0&&u.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(n)}else if(this.version==1)for(s=0;s<e;s++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())});r.createBoxCtor("dac3",function(t){var e=t.readUint8(),s=t.readUint8(),n=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|s>>6&3,this.acmod=s>>3&7,this.lfeon=s>>2&1,this.bit_rate_code=s&3|n>>5&7});r.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var s=0;s<this.num_ind_sub+1;s++){var n={};this.ind_subs.push(n);var o=t.readUint8(),a=t.readUint8(),h=t.readUint8();n.fscod=o>>6,n.bsid=o>>1&31,n.bsmod=(o&1)<<4|a>>4&15,n.acmod=a>>1&7,n.lfeon=a&1,n.num_dep_sub=h>>1&15,n.num_dep_sub>0&&(n.chan_loc=(h&1)<<8|t.readUint8())}});r.createFullBoxCtor("dfLa",function(t){var e=127,s=128,n=[],o=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(t);do{var a=t.readUint8(),h=Math.min(a&e,o.length-1);if(h?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),n.push(o[h]),a&s)break}while(!0);this.numMetadataBlocks=n.length+" ("+n.join(", ")+")"});r.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()});r.createBoxCtor("dmax",function(t){this.time=t.readUint32()});r.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()});r.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}});r.createFullBoxCtor("dref",function(t){var e,s;this.entries=[];for(var n=t.readUint32(),o=0;o<n;o++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)s=e.box,this.entries.push(s);else return});r.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()});r.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)});r.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var n={};this.entries.push(n),this.version===1?(n.segment_duration=t.readUint64(),n.media_time=t.readInt64()):(n.segment_duration=t.readUint32(),n.media_time=t.readInt32()),n.media_rate_integer=t.readInt16(),n.media_rate_fraction=t.readInt16()}});r.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)});r.createEntityToGroupCtor=function(t,e){r[t+"Box"]=function(s){r.FullBox.call(this,t,s)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(s){if(this.parseFullHeader(s),e)e.call(this,s);else for(this.group_id=s.readUint32(),this.num_entities_in_group=s.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var n=s.readUint32();this.entity_ids.push(n)}}};r.createEntityToGroupCtor("aebr");r.createEntityToGroupCtor("afbr");r.createEntityToGroupCtor("albc");r.createEntityToGroupCtor("altr");r.createEntityToGroupCtor("brst");r.createEntityToGroupCtor("dobr");r.createEntityToGroupCtor("eqiv");r.createEntityToGroupCtor("favc");r.createEntityToGroupCtor("fobr");r.createEntityToGroupCtor("iaug");r.createEntityToGroupCtor("pano");r.createEntityToGroupCtor("slid");r.createEntityToGroupCtor("ster");r.createEntityToGroupCtor("tsyn");r.createEntityToGroupCtor("wbbr");r.createEntityToGroupCtor("prgr");r.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(typeof St<"u"){var s=new St;this.esd=s.parseOneDescriptor(new d(e.buffer,0,d.BIG_ENDIAN))}});r.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()});r.createBoxCtor("frma",function(t){this.data_format=t.readString(4)});r.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var s=0;e>=4;)this.compatible_brands[s]=t.readString(4),e-=4,s++});r.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))});r.createBoxCtor("hvcC",function(t){var e,s,n,o;this.configurationVersion=t.readUint8(),o=t.readUint8(),this.general_profile_space=o>>6,this.general_tier_flag=(o&32)>>5,this.general_profile_idc=o&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),o=t.readUint8(),this.constantFrameRate=o>>6,this.numTemporalLayers=(o&13)>>3,this.temporalIdNested=(o&4)>>2,this.lengthSizeMinusOne=o&3,this.nalu_arrays=[];var a=t.readUint8();for(e=0;e<a;e++){var h=[];this.nalu_arrays.push(h),o=t.readUint8(),h.completeness=(o&128)>>7,h.nalu_type=o&63;var l=t.readUint16();for(s=0;s<l;s++){var f={};h.push(f),n=t.readUint16(),f.data=t.readUint8Array(n)}}});r.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var s=0;s<this.entry_count;s++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)e.box.type!=="infe"&&u.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[s]=e.box;else return});r.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var s=0;if(this.version<2)s=t.readUint16();else if(this.version===2)s=t.readUint32();else throw"version of iloc box not supported";for(var n=0;n<s;n++){var o={};if(this.items.push(o),this.version<2)o.item_ID=t.readUint16();else if(this.version===2)o.item_ID=t.readUint32();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?o.construction_method=t.readUint16()&15:o.construction_method=0,o.data_reference_index=t.readUint16(),this.base_offset_size){case 0:o.base_offset=0;break;case 4:o.base_offset=t.readUint32();break;case 8:o.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var a=t.readUint16();o.extents=[];for(var h=0;h<a;h++){var l={};if(o.extents.push(l),this.version===1||this.version===2)switch(this.index_size){case 0:l.extent_index=0;break;case 4:l.extent_index=t.readUint32();break;case 8:l.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:l.extent_offset=0;break;case 4:l.extent_offset=t.readUint32();break;case 8:l.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:l.extent_length=0;break;case 4:l.extent_length=t.readUint32();break;case 8:l.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}});r.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1});r.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),u.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))});r.createFullBoxCtor("ipma",function(t){var e,s;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var n={};this.associations.push(n),this.version<1?n.id=t.readUint16():n.id=t.readUint32();var o=t.readUint8();for(n.props=[],s=0;s<o;s++){var a=t.readUint8(),h={};n.props.push(h),h.essential=(a&128)>>7===1,this.flags&1?h.property_index=(a&127)<<8|t.readUint8():h.property_index=a&127}}});r.createFullBoxCtor("iref",function(t){var e,s;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)this.version===0?s=new r.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):s=new r.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),s.write===r.Box.prototype.write&&s.type!=="mdat"&&(u.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.references.push(s);else return});r.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3});r.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()});r.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()});r.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var s=0;s<e;s++){var n={};this.levels[s]=n,n.track_ID=t.readUint32();var o=t.readUint8();switch(n.padding_flag=o>>7,n.assignment_type=o&127,n.assignment_type){case 0:n.grouping_type=t.readString(4);break;case 1:n.grouping_type=t.readString(4),n.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:n.sub_track_id=t.readUint32();break;default:u.warn("BoxParser","Unknown leva assignement type")}}});r.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()});r.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()});function Z(t,e){this.x=t,this.y=e}Z.prototype.toString=function(){return"("+this.x+","+this.y+")"};r.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]=new Z(t.readUint16(),t.readUint16()),this.display_primaries[1]=new Z(t.readUint16(),t.readUint16()),this.display_primaries[2]=new Z(t.readUint16(),t.readUint16()),this.white_point=new Z(t.readUint16(),t.readUint16()),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()});r.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()});r.createFullBoxCtor("mehd",function(t){this.flags&1&&(u.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()});r.createFullBoxCtor("meta",function(t){this.boxes=[],r.ContainerBox.prototype.parse.call(this,t)});r.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()});r.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()});r.createFullBoxCtor("mskC",function(t){this.bits_per_pixel=t.readUint8()});r.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()});r.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()});r.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()});r.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var s=0;s<Math.floor((e+1)/2);s++)this.padbits=t.readUint8()});r.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()});r.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)});r.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)});r.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var s=0;s<e;s++)this.rate[s]=t.readUint32(),this.initial_delay[s]=t.readUint32()});r.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()});r.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()});r.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()});r.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()});r.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()});r.createFullBoxCtor("pssh",function(t){if(this.system_id=r.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var s=0;s<e;s++)this.kid[s]=r.parseHex16(t)}var n=t.readUint32();n>0&&(this.data=t.readUint8Array(n))});r.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()});r.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()});r.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()});r.createContainerBoxCtor("tapt",null,["clef","prof","enof"]);r.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)});r.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var s=0;s<e;s++)this.version===0?this.offset[s]=t.readUint32():this.offset[s]=t.readUint64()});r.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var s=0;s<e;s++)this.sample_info_size[s]=t.readUint8()});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)});r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)});r.createSampleGroupCtor("alst",function(t){var e,s=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<s;e++)this.sample_offset[e]=t.readUint32();var n=this.description_length-4-4*s;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<n/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()});r.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()});r.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var s=t.readUint8(),n=0;n<s;n++){var o={};this.dependency.push(o),o.subSeqDirectionFlag=t.readUint8(),o.layerNumber=t.readUint8(),o.subSequenceIdentifier=t.readUint16()}});r.createSampleGroupCtor("dtrt",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("mvif",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()});r.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127});r.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)u.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}});r.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()});r.SampleGroupEntry.prototype.parse=function(t){u.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)};r.createSampleGroupCtor("scif",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("scnm",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=r.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))});r.createSampleGroupCtor("stsa",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63});r.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7});r.createSampleGroupCtor("tsas",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("tscl",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createSampleGroupCtor("vipr",function(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")});r.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var n={};this.entries.push(n),n.sample_count=t.readInt32(),n.group_description_index=t.readInt32()}});function qt(t,e){this.bad_pixel_row=t,this.bad_pixel_column=e}qt.prototype.toString=function(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"};r.createFullBoxCtor("sbpm",function(t){var e;for(this.component_count=t.readUint16(),this.component_index=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16());var s=t.readUint8();for(this.correction_applied=(s&128)==128,this.num_bad_rows=t.readUint32(),this.num_bad_cols=t.readUint32(),this.num_bad_pixels=t.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[],e=0;e<this.num_bad_rows;e++)this.bad_rows.push(t.readUint32());for(e=0;e<this.num_bad_cols;e++)this.bad_columns.push(t.readUint32());for(e=0;e<this.num_bad_pixels;e++){var n=t.readUint32(),o=t.readUint32();this.bad_pixels.push(new qt(n,o))}});r.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))});r.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)});r.createFullBoxCtor("sdtp",function(t){var e,s=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var n=0;n<s;n++)e=t.readUint8(),this.is_leading[n]=e>>6,this.sample_depends_on[n]=e>>4&3,this.sample_is_depended_on[n]=e>>2&3,this.sample_has_redundancy[n]=e&3});r.createFullBoxCtor("senc");r.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),u.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var n;r[this.grouping_type+"SampleGroupEntry"]?n=new r[this.grouping_type+"SampleGroupEntry"](this.grouping_type):n=new r.SampleGroupEntry(this.grouping_type),this.entries.push(n),this.version===1?this.default_length===0?n.description_length=t.readUint32():n.description_length=this.default_length:n.description_length=this.default_length,n.write===r.SampleGroupEntry.prototype.write&&(u.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),n.data=t.readUint8Array(n.description_length),t.position-=n.description_length),n.parse(t)}});r.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),s=0;s<e;s++){var n={};this.references.push(n);var o=t.readUint32();n.reference_type=o>>31&1,n.referenced_size=o&2147483647,n.subsegment_duration=t.readUint32(),o=t.readUint32(),n.starts_with_SAP=o>>31&1,n.SAP_type=o>>28&7,n.SAP_delta_time=o&268435455}});r.SingleItemTypeReferenceBox=function(t,e,s,n){r.Box.call(this,t,e),this.hdr_size=s,this.start=n};r.SingleItemTypeReferenceBox.prototype=new r.Box;r.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var s=0;s<e;s++)this.references[s]={},this.references[s].to_item_ID=t.readUint16()};r.SingleItemTypeReferenceBoxLarge=function(t,e,s,n){r.Box.call(this,t,e),this.hdr_size=s,this.start=n};r.SingleItemTypeReferenceBoxLarge.prototype=new r.Box;r.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var s=0;s<e;s++)this.references[s]={},this.references[s].to_item_ID=t.readUint32()};r.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()});r.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()});r.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),s=0;s<e;s++){var n={};this.subsegments.push(n),n.ranges=[];for(var o=t.readUint32(),a=0;a<o;a++){var h={};n.ranges.push(h),h.level=t.readUint8(),h.range_size=t.readUint24()}}});r.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var s=0;s<e;s++)this.chunk_offsets.push(t.readUint32())});r.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var s=0;s<e;s++)this.priority[s]=t.readUint16()});r.createFullBoxCtor("sthd");r.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var s=0;s<e;s++)this.attribute_list[s]=t.readUint32()});r.createFullBoxCtor("stsc",function(t){var e,s;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(s=0;s<e;s++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())});r.createFullBoxCtor("stsd",function(t){var e,s,n,o;for(this.entries=[],n=t.readUint32(),e=1;e<=n;e++)if(s=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),s.code===r.OK)r[s.type+"SampleEntry"]?(o=new r[s.type+"SampleEntry"](s.size),o.hdr_size=s.hdr_size,o.start=s.start):(u.warn("BoxParser","Unknown sample entry type: "+s.type),o=new r.SampleEntry(s.type,s.size,s.hdr_size,s.start)),o.write===r.SampleEntry.prototype.write&&(u.info("BoxParser","SampleEntry "+o.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(t)),o.parse(t),this.entries.push(o);else return});r.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var s=0;s<e;s++)this.group_description_index[s]=t.readUint32()});r.createFullBoxCtor("stsh",function(t){var e,s;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(s=0;s<e;s++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())});r.createFullBoxCtor("stss",function(t){var e,s;if(s=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<s;e++)this.sample_numbers.push(t.readUint32())});r.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size});r.createFullBoxCtor("stts",function(t){var e,s,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(s=0;s<e;s++)this.sample_counts.push(t.readUint32()),n=t.readInt32(),n<0&&(u.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),n=1),this.sample_deltas.push(n)});r.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var s=t.readUint32();this.stereo_indication_type=t.readString(s);var n,o;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(n=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),n.code===r.OK)o=n.box,this.boxes.push(o),this[o.type]=o;else return});r.createBoxCtor("styp",function(t){r.ftypBox.prototype.parse.call(this,t)});r.createFullBoxCtor("stz2",function(t){var e,s;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),s=t.readUint32(),this.field_size===4)for(e=0;e<s;e+=2){var n=t.readUint8();this.sample_sizes[e]=n>>4&15,this.sample_sizes[e+1]=n&15}else if(this.field_size===8)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint16();else u.error("BoxParser","Error in length field in stz2 box")});r.createFullBoxCtor("subs",function(t){var e,s,n,o;for(n=t.readUint32(),this.entries=[],e=0;e<n;e++){var a={};if(this.entries[e]=a,a.sample_delta=t.readUint32(),a.subsamples=[],o=t.readUint16(),o>0)for(s=0;s<o;s++){var h={};a.subsamples.push(h),this.version==1?h.size=t.readUint32():h.size=t.readUint16(),h.priority=t.readUint8(),h.discardable=t.readUint8(),h.codec_specific_parameters=t.readUint32()}}});r.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=r.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))});r.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()});r.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0});r.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var s=t.readUint32(),n=0;n<s;n++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()});r.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()});r.createBoxCtor("tmax",function(t){this.time=t.readUint32()});r.createBoxCtor("tmin",function(t){this.time=t.readUint32()});r.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()});r.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()});r.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()});r.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()};r.createTrackGroupCtor("msrc");r.TrackReferenceTypeBox=function(t,e,s,n){r.Box.call(this,t,e),this.hdr_size=s,this.start=n};r.TrackReferenceTypeBox.prototype=new r.Box;r.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)};r.trefBox.prototype.parse=function(t){for(var e,s;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)s=new r.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),s.write===r.Box.prototype.write&&s.type!=="mdat"&&(u.info("BoxParser","TrackReference "+s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.boxes.push(s);else return};r.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===r.OK)box=ret.box,this.boxes.push(box);else return});r.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()});r.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()});r.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var s=0;s<this.sample_count;s++)this.flags&r.TRUN_FLAGS_DURATION&&(this.sample_duration[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_SIZE&&(this.sample_size[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_FLAGS&&(this.sample_flags[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[s]=t.readUint32():this.sample_composition_time_offset[s]=t.readInt32())});r.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var s=0;s<e;s++)this.attribute_list[s]=t.readUint32()});r.createFullBoxCtor("txtC",function(t){this.config=t.readCString()});r.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var s=0;s<e;s++)this.compatible_brands[s]=t.readString(4)});r.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()});r.createFullBoxCtor("uncC",function(t){var e;if(this.profile=t.readUint32(),this.version!=1){if(this.version==0){for(this.component_count=t.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var s=t.readUint8();this.component_little_endian=s>>7&1,this.block_pad_lsb=s>>6&1,this.block_little_endian=s>>5&1,this.block_reversed=s>>4&1,this.pad_unknown=s>>3&1,this.pixel_size=t.readUint32(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}}});r.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())});r.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())});r.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")});r.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=r.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))});r.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1);r.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=r.parseHex16(t)});r.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var s={},n=0,o=0;this.version===1?(n=t.readUint64(),o=t.readUint64()):(n=t.readUint32(),o=t.readUint32()),s.absolute_time=n,s.absolute_duration=o,this.entries.push(s)}});r.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())});r.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)});r.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))});r.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)});r.createFullBoxCtor("vvcC",function(t){var e,s,n={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(g){this.held_bits=g.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(g){this.held_bits=g.readUint16(),this.num_held_bits=16},extract_bits:function(g){var v=this.held_bits>>this.num_held_bits-g&(1<<g)-1;return this.num_held_bits-=g,v}};if(n.stream_read_1_bytes(t),n.extract_bits(5),this.lengthSizeMinusOne=n.extract_bits(2),this.ptl_present_flag=n.extract_bits(1),this.ptl_present_flag){n.stream_read_2_bytes(t),this.ols_idx=n.extract_bits(9),this.num_sublayers=n.extract_bits(3),this.constant_frame_rate=n.extract_bits(2),this.chroma_format_idc=n.extract_bits(2),n.stream_read_1_bytes(t),this.bit_depth_minus8=n.extract_bits(3),n.extract_bits(5);{if(n.stream_read_2_bytes(t),n.extract_bits(2),this.num_bytes_constraint_info=n.extract_bits(6),this.general_profile_idc=n.extract_bits(7),this.general_tier_flag=n.extract_bits(1),this.general_level_idc=t.readUint8(),n.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=n.extract_bits(1),this.ptl_multilayer_enabled_flag=n.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var o=n.extract_bits(6);n.stream_read_1_bytes(t);var a=n.extract_bits(2);this.general_constraint_info[e]=o<<2|a}this.general_constraint_info[this.num_bytes_constraint_info-1]=n.extract_bits(6)}else n.extract_bits(6);if(this.num_sublayers>1){for(n.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,s=this.num_sublayers-2;s>=0;--s){var h=n.extract_bits(1);this.ptl_sublayer_present_mask|=h<<s}for(s=this.num_sublayers;s<=8&&this.num_sublayers>1;++s)n.extract_bits(1);for(this.sublayer_level_idc=[],s=this.num_sublayers-2;s>=0;--s)this.ptl_sublayer_present_mask&1<<s&&(this.sublayer_level_idc[s]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var l=12,f=13;this.nalu_arrays=[];var c=t.readUint8();for(e=0;e<c;e++){var p=[];this.nalu_arrays.push(p),n.stream_read_1_bytes(t),p.completeness=n.extract_bits(1),n.extract_bits(2),p.nalu_type=n.extract_bits(5);var _=1;for(p.nalu_type!=f&&p.nalu_type!=l&&(_=t.readUint16()),s=0;s<_;s++){var m=t.readUint16();p.push({data:t.readUint8Array(m),length:m})}}});r.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3});r.SampleEntry.prototype.isVideo=function(){return!1};r.SampleEntry.prototype.isAudio=function(){return!1};r.SampleEntry.prototype.isSubtitle=function(){return!1};r.SampleEntry.prototype.isMetadata=function(){return!1};r.SampleEntry.prototype.isHint=function(){return!1};r.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")};r.SampleEntry.prototype.getWidth=function(){return""};r.SampleEntry.prototype.getHeight=function(){return""};r.SampleEntry.prototype.getChannelCount=function(){return""};r.SampleEntry.prototype.getSampleRate=function(){return""};r.SampleEntry.prototype.getSampleSize=function(){return""};r.VisualSampleEntry.prototype.isVideo=function(){return!0};r.VisualSampleEntry.prototype.getWidth=function(){return this.width};r.VisualSampleEntry.prototype.getHeight=function(){return this.height};r.AudioSampleEntry.prototype.isAudio=function(){return!0};r.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count};r.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate};r.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize};r.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0};r.MetadataSampleEntry.prototype.isMetadata=function(){return!0};r.decimalToHex=function(t,e){var s=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;s.length<e;)s="0"+s;return s};r.avc1SampleEntry.prototype.getCodec=r.avc2SampleEntry.prototype.getCodec=r.avc3SampleEntry.prototype.getCodec=r.avc4SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+r.decimalToHex(this.avcC.AVCProfileIndication)+r.decimalToHex(this.avcC.profile_compatibility)+r.decimalToHex(this.avcC.AVCLevelIndication):t};r.hev1SampleEntry.prototype.getCodec=r.hvc1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var s=this.hvcC.general_profile_compatibility,n=0;for(t=0;t<32&&(n|=s&1,t!=31);t++)n<<=1,s>>=1;e+=r.decimalToHex(n,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var o=!1,a="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||o)&&(a="."+r.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+a,o=!0);e+=a}return e};r.vvc1SampleEntry.prototype.getCodec=r.vvi1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var s="";if(this.vvcC.general_constraint_info){var n=[],o=0;o|=this.vvcC.ptl_frame_only_constraint<<7,o|=this.vvcC.ptl_multilayer_enabled<<6;var a;for(t=0;t<this.vvcC.general_constraint_info.length;++t)o|=this.vvcC.general_constraint_info[t]>>2&63,n.push(o),o&&(a=t),o=this.vvcC.general_constraint_info[t]>>2&3;if(a===void 0)s=".CA";else{s=".C";var h="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",l=0,f=0;for(t=0;t<=a;++t)for(l=l<<8|n[t],f+=8;f>=5;){var c=l>>f-5&31;s+=h[c],f-=5,l&=(1<<f)-1}f&&(l<<=5-f,s+=h[l&31])}}e+=s}return e};r.mp4aSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),s=this.esds.esd.getAudioConfig();return t+"."+r.decimalToHex(e)+(s?"."+s:"")}else return t};r.stxtSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t};r.vp08SampleEntry.prototype.getCodec=r.vp09SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var s=this.vpcC.bitDepth;return s==8&&(s="08"),t+".0"+this.vpcC.profile+"."+e+"."+s};r.av01SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var s;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?s=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(s=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+s};r.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>H&&(this.size+=8),this.type==="uuid"&&(this.size+=16),u.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>H?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>H&&t.writeUint64(this.size)};r.FullBox.prototype.writeHeader=function(t){this.size+=4,r.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)};r.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))};r.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};r.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)};r.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)};r.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])};r.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)};r.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])};r.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};r.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)};r.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var s=this.entries[e];t.writeUint32(s.segment_duration),t.writeInt32(s.media_time),t.writeInt16(s.media_rate_integer),t.writeInt16(s.media_rate_fraction)}};r.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)};r.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)};r.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)};r.hvcCBox.prototype.write=function(t){var e,s;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,s=0;s<this.nalu_arrays[e].length;s++)this.size+=2+this.nalu_arrays[e][s].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.general_profile_space<<6+this.general_tier_flag<<5+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),s=0;s<this.nalu_arrays[e].length;s++)t.writeUint16(this.nalu_arrays[e][s].data.length),t.writeUint8Array(this.nalu_arrays[e][s].data)};r.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)};r.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)};r.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)};r.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)};r.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)};r.SampleEntry.prototype.writeHeader=function(t){this.size=8,r.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)};r.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};r.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};r.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)};r.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)};r.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)};r.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)};r.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var s=this.entries[e];t.writeInt32(s.sample_count),t.writeInt32(s.group_description_index)}};r.sgpdBox.prototype.write=function(t){var e,s;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)s=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=s.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)s=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(s.description_length),s.write(t)};r.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var s=this.references[e];t.writeUint32(s.reference_type<<31|s.referenced_size),t.writeUint32(s.subsegment_duration),t.writeUint32(s.starts_with_SAP<<31|s.SAP_type<<28|s.SAP_delta_time)}};r.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)};r.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)};r.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])};r.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)};r.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])};r.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)};r.stszBox.prototype.write=function(t){var e,s=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){s=!1;break}else e++;else s=!1;this.size=8,s||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),s?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),s||t.writeUint32Array(this.sample_sizes)};r.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])};r.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)};r.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)};r.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)};r.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)};r.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&r.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&r.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&r.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&r.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&r.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&r.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))};r["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)};r["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)};r.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)};r.cttsBox.prototype.unpack=function(t){var e,s,n;for(n=0,e=0;e<this.sample_counts.length;e++)for(s=0;s<this.sample_counts[e];s++)t[n].pts=t[n].dts+this.sample_offsets[e],n++};r.sttsBox.prototype.unpack=function(t){var e,s,n;for(n=0,e=0;e<this.sample_counts.length;e++)for(s=0;s<this.sample_counts[e];s++)n===0?t[n].dts=0:t[n].dts=t[n-1].dts+this.sample_deltas[e],n++};r.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]};r.stscBox.prototype.unpack=function(t){var e,s,n,o,a;for(o=0,a=0,e=0;e<this.first_chunk.length;e++)for(s=0;s<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);s++)for(a++,n=0;n<this.samples_per_chunk[e];n++){if(t[o])t[o].description_index=this.sample_description_index[e],t[o].chunk_index=a;else return;o++}};r.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]};r.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"];r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];r.boxEqualFields=function(t,e){if(t&&!e)return!1;var s;for(s in t)if(!(r.DIFF_BOXES_PROP_NAMES.indexOf(s)>-1)){if(t[s]instanceof r.Box||e[s]instanceof r.Box)continue;if(typeof t[s]>"u"||typeof e[s]>"u")continue;if(typeof t[s]=="function"||typeof e[s]=="function")continue;if(t.subBoxNames&&t.subBoxNames.indexOf(s.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(s.slice(0,4))>-1)continue;if(s==="data"||s==="start"||s==="size"||s==="creation_time"||s==="modification_time")continue;if(r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(s)>-1)continue;if(t[s]!==e[s])return!1}return!0};r.boxEqual=function(t,e){if(!r.boxEqualFields(t,e))return!1;for(var s=0;s<r.DIFF_BOXES_PROP_NAMES.length;s++){var n=r.DIFF_BOXES_PROP_NAMES[s];if(t[n]&&e[n]&&!r.boxEqual(t[n],e[n]))return!1}return!0};var Kt=function(){};Kt.prototype.parseSample=function(t){var e={},s;e.resources=[];var n=new b(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=n.readString(t.data.length);else if(e.documentString=n.readString(t.subsamples[0].size),t.subsamples.length>1)for(s=1;s<t.subsamples.length;s++)e.resources[s]=n.readUint8Array(t.subsamples[s].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var bt=function(){};bt.prototype.parseSample=function(t){var e,s=new b(t.data.buffer);return e=s.readString(t.data.length),e};bt.prototype.parseConfig=function(t){var e,s=new b(t.buffer);return s.readUint32(),e=s.readCString(),e};typeof w<"u"&&(w.XMLSubtitlein4Parser=Kt,w.Textin4Parser=bt);var y=function(t){this.stream=t||new E,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};y.prototype.setSegmentOptions=function(t,e,s){var n=this.getTrackById(t);if(n){var o={};this.fragmentedTracks.push(o),o.id=t,o.user=e,o.trak=n,n.nextSample=0,o.segmentStream=null,o.nb_samples=1e3,o.rapAlignement=!0,s&&(s.nbSamples&&(o.nb_samples=s.nbSamples),s.rapAlignement&&(o.rapAlignement=s.rapAlignement))}};y.prototype.unsetSegmentOptions=function(t){for(var e=-1,s=0;s<this.fragmentedTracks.length;s++){var n=this.fragmentedTracks[s];n.id==t&&(e=s)}e>-1&&this.fragmentedTracks.splice(e,1)};y.prototype.setExtractionOptions=function(t,e,s){var n=this.getTrackById(t);if(n){var o={};this.extractedTracks.push(o),o.id=t,o.user=e,o.trak=n,n.nextSample=0,o.nb_samples=1e3,o.samples=[],s&&s.nbSamples&&(o.nb_samples=s.nbSamples)}};y.prototype.unsetExtractionOptions=function(t){for(var e=-1,s=0;s<this.extractedTracks.length;s++){var n=this.extractedTracks[s];n.id==t&&(e=s)}e>-1&&this.extractedTracks.splice(e,1)};y.prototype.parse=function(){var t,e,s=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=r.parseOneBox(this.stream,s),t.code===r.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var n;switch(e=t.box,n=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),n){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[n]!==void 0&&u.warn("ISOFile","Duplicate Box of type: "+n+", overriding previous occurrence"),this[n]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}};y.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(u.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(u.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(u.warn("ISOFile","Not ready to start parsing"),!1))};y.prototype.appendBuffer=function(t,e){var s;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(s=this.nextSeekPosition,this.nextSeekPosition=void 0):s=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(s=this.stream.getEndFilePositionAfter(s))):this.nextParsePosition?s=this.nextParsePosition:s=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(u.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+s),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),u.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),s};y.prototype.getInfo=function(){var t,e,s={},n,o,a,h,l=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(s.hasMoov=!0,s.duration=this.moov.mvhd.duration,s.timescale=this.moov.mvhd.timescale,s.isFragmented=this.moov.mvex!=null,s.isFragmented&&this.moov.mvex.mehd&&(s.fragment_duration=this.moov.mvex.mehd.fragment_duration),s.isProgressive=this.isProgressive,s.hasIOD=this.moov.iods!=null,s.brands=[],s.brands.push(this.ftyp.major_brand),s.brands=s.brands.concat(this.ftyp.compatible_brands),s.created=new Date(l+this.moov.mvhd.creation_time*1e3),s.modified=new Date(l+this.moov.mvhd.modification_time*1e3),s.tracks=[],s.audioTracks=[],s.videoTracks=[],s.subtitleTracks=[],s.metadataTracks=[],s.hintTracks=[],s.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(n=this.moov.traks[t],h=n.mdia.minf.stbl.stsd.entries[0],o={},s.tracks.push(o),o.id=n.tkhd.track_id,o.name=n.mdia.hdlr.name,o.references=[],n.tref)for(e=0;e<n.tref.boxes.length;e++)a={},o.references.push(a),a.type=n.tref.boxes[e].type,a.track_ids=n.tref.boxes[e].track_ids;n.edts&&(o.edits=n.edts.elst.entries),o.created=new Date(l+n.tkhd.creation_time*1e3),o.modified=new Date(l+n.tkhd.modification_time*1e3),o.movie_duration=n.tkhd.duration,o.movie_timescale=s.timescale,o.layer=n.tkhd.layer,o.alternate_group=n.tkhd.alternate_group,o.volume=n.tkhd.volume,o.matrix=n.tkhd.matrix,o.track_width=n.tkhd.width/65536,o.track_height=n.tkhd.height/65536,o.timescale=n.mdia.mdhd.timescale,o.cts_shift=n.mdia.minf.stbl.cslg,o.duration=n.mdia.mdhd.duration,o.samples_duration=n.samples_duration,o.codec=h.getCodec(),o.kind=n.udta&&n.udta.kinds.length?n.udta.kinds[0]:{schemeURI:"",value:""},o.language=n.mdia.elng?n.mdia.elng.extended_language:n.mdia.mdhd.languageString,o.nb_samples=n.samples.length,o.size=n.samples_size,o.bitrate=o.size*8*o.timescale/o.samples_duration,h.isAudio()?(o.type="audio",s.audioTracks.push(o),o.audio={},o.audio.sample_rate=h.getSampleRate(),o.audio.channel_count=h.getChannelCount(),o.audio.sample_size=h.getSampleSize()):h.isVideo()?(o.type="video",s.videoTracks.push(o),o.video={},o.video.width=h.getWidth(),o.video.height=h.getHeight()):h.isSubtitle()?(o.type="subtitles",s.subtitleTracks.push(o)):h.isHint()?(o.type="metadata",s.hintTracks.push(o)):h.isMetadata()?(o.type="metadata",s.metadataTracks.push(o)):(o.type="metadata",s.otherTracks.push(o))}else s.hasMoov=!1;if(s.mime="",s.hasMoov&&s.tracks){for(s.videoTracks&&s.videoTracks.length>0?s.mime+='video/mp4; codecs="':s.audioTracks&&s.audioTracks.length>0?s.mime+='audio/mp4; codecs="':s.mime+='application/mp4; codecs="',t=0;t<s.tracks.length;t++)t!==0&&(s.mime+=","),s.mime+=s.tracks[t].codec;s.mime+='"; profiles="',s.mime+=this.ftyp.compatible_brands.join(),s.mime+='"'}return s};y.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)};y.prototype.processSamples=function(t){var e,s;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var n=this.fragmentedTracks[e];for(s=n.trak;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){u.debug("ISOFile","Creating media fragment on track #"+n.id+" for sample "+s.nextSample);var o=this.createFragment(n.id,s.nextSample,n.segmentStream);if(o)n.segmentStream=o,s.nextSample++;else break;if((s.nextSample%n.nb_samples===0||t||s.nextSample>=s.samples.length)&&(u.info("ISOFile","Sending fragmented data on track #"+n.id+" for samples ["+Math.max(0,s.nextSample-n.nb_samples)+","+(s.nextSample-1)+"]"),u.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(n.id,n.user,n.segmentStream.buffer,s.nextSample,t||s.nextSample>=s.samples.length),n.segmentStream=null,n!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var a=this.extractedTracks[e];for(s=a.trak;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){u.debug("ISOFile","Exporting on track #"+a.id+" sample #"+s.nextSample);var h=this.getSample(s,s.nextSample);if(h)s.nextSample++,a.samples.push(h);else{this.setNextSeekPositionFromSample(s.samples[s.nextSample]);break}if((s.nextSample%a.nb_samples===0||s.nextSample>=s.samples.length)&&(u.debug("ISOFile","Sending samples on track #"+a.id+" for sample "+s.nextSample),this.onSamples&&this.onSamples(a.id,a.user,a.samples),a.samples=[],a!==this.extractedTracks[e]))break}}}};y.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null};y.prototype.getBoxes=function(t,e){var s=[];return y._sweep.call(this,t,s,e),s};y._sweep=function(t,e,s){this.type&&this.type==t&&e.push(this);for(var n in this.boxes){if(e.length&&s)return;y._sweep.call(this.boxes[n],t,e,s)}};y.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples};y.prototype.getTrackSample=function(t,e){var s=this.getTrackById(t),n=this.getSample(s,e);return n};y.prototype.releaseUsedSamples=function(t,e){var s=0,n=this.getTrackById(t);n.lastValidSample||(n.lastValidSample=0);for(var o=n.lastValidSample;o<e;o++)s+=this.releaseSample(n,o);u.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+s+", remaining: "+this.samplesDataSize+")"),n.lastValidSample=e};y.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)};y.prototype.stop=function(){this.sampleProcessingStarted=!1};y.prototype.flush=function(){u.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)};y.prototype.seekTrack=function(t,e,s){var n,o,a=1/0,h=0,l=0,f;if(s.samples.length===0)return u.info("ISOFile","No sample in track, cannot seek! Using time "+u.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(n=0;n<s.samples.length;n++){if(o=s.samples[n],n===0)l=0,f=o.timescale;else if(o.cts>t*o.timescale){l=n-1;break}e&&o.is_sync&&(h=n)}for(e&&(l=h),t=s.samples[l].cts,s.nextSample=l;s.samples[l].alreadyRead===s.samples[l].size&&s.samples[l+1];)l++;return a=s.samples[l].offset+s.samples[l].alreadyRead,u.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+s.nextSample+" on track "+s.tkhd.track_id+", time "+u.getDurationString(t,f)+" and offset: "+a),{offset:a,time:t/f}};y.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0};y.prototype.seek=function(t,e){var s=this.moov,n,o,a,h={offset:1/0,time:1/0};if(this.moov){for(a=0;a<s.traks.length;a++)n=s.traks[a],!(t>this.getTrackDuration(n))&&(o=this.seekTrack(t,e,n),o.offset<h.offset&&(h.offset=o.offset),o.time<h.time&&(h.time=o.time));return u.info("ISOFile","Seeking at time "+u.getDurationString(h.time,1)+" needs a buffer with a fileStart position of "+h.offset),h.offset===1/0?h={offset:this.nextParsePosition,time:0}:h.offset=this.stream.getEndFilePositionAfter(h.offset),u.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+h.offset),h}else throw"Cannot seek: moov not received!"};y.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var s=this.boxes[e],n=t.boxes[e];if(!r.boxEqual(s,n))return!1;e++}return!0};typeof w<"u"&&(w.ISOFile=y);y.prototype.lastBoxStartPosition=0;y.prototype.parsingMdat=null;y.prototype.nextParsePosition=0;y.prototype.discardMdatData=!1;y.prototype.processIncompleteBox=function(t){var e,s,n;return t.type==="mdat"?(e=new r[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,n=this.stream.seek(e.start+e.size,!1,this.discardMdatData),n?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),s=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,s?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))};y.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null};y.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(u.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)};y.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)};y.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()};y.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))};y.prototype.add=r.Box.prototype.add;y.prototype.addBox=r.Box.prototype.addBox;y.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var s=this.add("moov");return s.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),s.add("mvex"),this};y.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var s=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,s.add("tkhd").set("flags",r.TKHD_FLAG_ENABLED|r.TKHD_FLAG_IN_MOVIE|r.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var n=s.add("mdia");n.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),n.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),n.add("elng").set("extended_language",e.language||"fr-FR");var o=n.add("minf");if(r[e.type+"SampleEntry"]!==void 0){var a=new r[e.type+"SampleEntry"];a.data_reference_index=1;var h="";for(var l in r.sampleEntryCodes)for(var f=r.sampleEntryCodes[l],c=0;c<f.length;c++)if(f.indexOf(e.type)>-1){h=l;break}switch(h){case"Visual":if(o.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),a.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var p=new r.avcCBox;p.parse(new b(e.avcDecoderConfigRecord)),a.addBox(p)}else if(e.hevcDecoderConfigRecord){var _=new r.hvcCBox;_.parse(new b(e.hevcDecoderConfigRecord)),a.addBox(_)}break;case"Audio":o.add("smhd").set("balance",e.balance||0),a.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":o.add("hmhd");break;case"Subtitle":switch(o.add("sthd"),e.type){case"stpp":a.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":o.add("nmhd");break;case"System":o.add("nmhd");break;default:o.add("nmhd");break}e.description&&a.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(g){a.addBox(g)}),o.add("dinf").add("dref").addEntry(new r["url Box"]().set("flags",1));var m=o.add("stbl");return m.add("stsd").addEntry(a),m.add("stts").set("sample_counts",[]).set("sample_deltas",[]),m.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),m.add("stco").set("chunk_offsets",[]),m.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(s),e.id}};r.Box.prototype.computeSize=function(t){var e=t||new d;e.endianness=d.BIG_ENDIAN,this.write(e)};y.prototype.addSample=function(t,e,s){var n=s||{},o={},a=this.getTrackById(t);if(a!==null){o.number=a.samples.length,o.track_id=a.tkhd.track_id,o.timescale=a.mdia.mdhd.timescale,o.description_index=n.sample_description_index?n.sample_description_index-1:0,o.description=a.mdia.minf.stbl.stsd.entries[o.description_index],o.data=e,o.size=e.byteLength,o.alreadyRead=o.size,o.duration=n.duration||1,o.cts=n.cts||0,o.dts=n.dts||0,o.is_sync=n.is_sync||!1,o.is_leading=n.is_leading||0,o.depends_on=n.depends_on||0,o.is_depended_on=n.is_depended_on||0,o.has_redundancy=n.has_redundancy||0,o.degradation_priority=n.degradation_priority||0,o.offset=0,o.subsamples=n.subsamples,a.samples.push(o),a.samples_size+=o.size,a.samples_duration+=o.duration,a.first_dts===void 0&&(a.first_dts=n.dts),this.processSamples();var h=this.createSingleSampleMoof(o);return this.addBox(h),h.computeSize(),h.trafs[0].truns[0].data_offset=h.size+8,this.add("mdat").data=new Uint8Array(e),o}};y.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var s=new r.moofBox;s.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var n=s.add("traf"),o=this.getTrackById(t.track_id);return n.add("tfhd").set("track_id",t.track_id).set("flags",r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),n.add("tfdt").set("baseMediaDecodeTime",t.dts-(o.first_dts||0)),n.add("trun").set("flags",r.TRUN_FLAGS_DATA_OFFSET|r.TRUN_FLAGS_DURATION|r.TRUN_FLAGS_SIZE|r.TRUN_FLAGS_FLAGS|r.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),s};y.prototype.lastMoofIndex=0;y.prototype.samplesDataSize=0;y.prototype.resetTables=function(){var t,e,s,n,o,a,h,l;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,s=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,s.chunk_offsets=[],n=e.mdia.minf.stbl.stsc,n.first_chunk=[],n.samples_per_chunk=[],n.sample_description_index=[],o=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,o.sample_sizes=[],a=e.mdia.minf.stbl.stts,a.sample_counts=[],a.sample_deltas=[],h=e.mdia.minf.stbl.ctts,h&&(h.sample_counts=[],h.sample_offsets=[]),l=e.mdia.minf.stbl.stss;var f=e.mdia.minf.stbl.boxes.indexOf(l);f!=-1&&(e.mdia.minf.stbl.boxes[f]=null)}};y.initSampleGroups=function(t,e,s,n,o){var a,h,l,f;function c(p,_,m){this.grouping_type=p,this.grouping_type_parameter=_,this.sbgp=m,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),h=0;h<s.length;h++){for(f=s[h].grouping_type+"/"+s[h].grouping_type_parameter,l=new c(s[h].grouping_type,s[h].grouping_type_parameter,s[h]),e&&(e.sample_groups_info[f]=l),t.sample_groups_info[f]||(t.sample_groups_info[f]=l),a=0;a<n.length;a++)n[a].grouping_type===s[h].grouping_type&&(l.description=n[a],l.description.used=!0);if(o)for(a=0;a<o.length;a++)o[a].grouping_type===s[h].grouping_type&&(l.fragment_description=o[a],l.fragment_description.used=!0,l.is_fragment=!0)}if(e){if(o)for(h=0;h<o.length;h++)!o[h].used&&o[h].version>=2&&(f=o[h].grouping_type+"/0",l=new c(o[h].grouping_type,0),l.is_fragment=!0,e.sample_groups_info[f]||(e.sample_groups_info[f]=l))}else for(h=0;h<n.length;h++)!n[h].used&&n[h].version>=2&&(f=n[h].grouping_type+"/0",l=new c(n[h].grouping_type,0),t.sample_groups_info[f]||(t.sample_groups_info[f]=l))};y.setSampleGroupProperties=function(t,e,s,n){var o,a;e.sample_groups=[];for(o in n)if(e.sample_groups[o]={},e.sample_groups[o].grouping_type=n[o].grouping_type,e.sample_groups[o].grouping_type_parameter=n[o].grouping_type_parameter,s>=n[o].last_sample_in_run&&(n[o].last_sample_in_run<0&&(n[o].last_sample_in_run=0),n[o].entry_index++,n[o].entry_index<=n[o].sbgp.entries.length-1&&(n[o].last_sample_in_run+=n[o].sbgp.entries[n[o].entry_index].sample_count)),n[o].entry_index<=n[o].sbgp.entries.length-1?e.sample_groups[o].group_description_index=n[o].sbgp.entries[n[o].entry_index].group_description_index:e.sample_groups[o].group_description_index=-1,e.sample_groups[o].group_description_index!==0){var h;n[o].fragment_description?h=n[o].fragment_description:h=n[o].description,e.sample_groups[o].group_description_index>0?(e.sample_groups[o].group_description_index>65535?a=(e.sample_groups[o].group_description_index>>16)-1:a=e.sample_groups[o].group_description_index-1,h&&a>=0&&(e.sample_groups[o].description=h.entries[a])):h&&h.version>=2&&h.default_group_description_index>0&&(e.sample_groups[o].description=h.entries[h.default_group_description_index-1])}};y.process_sdtp=function(t,e,s){e&&(t?(e.is_leading=t.is_leading[s],e.depends_on=t.sample_depends_on[s],e.is_depended_on=t.sample_is_depended_on[s],e.has_redundancy=t.sample_has_redundancy[s]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))};y.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)};y.prototype.buildTrakSampleLists=function(t){var e,s,n,o,a,h,l,f,c,p,_,m,g,v,x,I,P,B,T,A,k,ft,N,W;if(t.samples=[],t.samples_duration=0,t.samples_size=0,s=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,n=t.mdia.minf.stbl.stsc,o=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,a=t.mdia.minf.stbl.stts,h=t.mdia.minf.stbl.ctts,l=t.mdia.minf.stbl.stss,f=t.mdia.minf.stbl.stsd,c=t.mdia.minf.stbl.subs,m=t.mdia.minf.stbl.stdp,p=t.mdia.minf.stbl.sbgps,_=t.mdia.minf.stbl.sgpds,B=-1,T=-1,A=-1,k=-1,ft=0,N=0,W=0,y.initSampleGroups(t,null,p,_),!(typeof o>"u")){for(e=0;e<o.sample_sizes.length;e++){var S={};if(S.number=e,S.track_id=t.tkhd.track_id,S.timescale=t.mdia.mdhd.timescale,S.alreadyRead=0,t.samples[e]=S,S.size=o.sample_sizes[e],t.samples_size+=S.size,e===0?(v=1,g=0,S.chunk_index=v,S.chunk_run_index=g,P=n.samples_per_chunk[g],I=0,g+1<n.first_chunk.length?x=n.first_chunk[g+1]-1:x=1/0):e<P?(S.chunk_index=v,S.chunk_run_index=g):(v++,S.chunk_index=v,I=0,v<=x||(g++,g+1<n.first_chunk.length?x=n.first_chunk[g+1]-1:x=1/0),S.chunk_run_index=g,P+=n.samples_per_chunk[g]),S.description_index=n.sample_description_index[S.chunk_run_index]-1,S.description=f.entries[S.description_index],S.offset=s.chunk_offsets[S.chunk_index-1]+I,I+=S.size,e>B&&(T++,B<0&&(B=0),B+=a.sample_counts[T]),e>0)t.samples[e-1].duration=a.sample_deltas[T],t.samples_duration+=t.samples[e-1].duration,S.dts=t.samples[e-1].dts+t.samples[e-1].duration;else{var Qt=t.boxes.find(te=>"track_id"in te).track_id,q=this.initialSample?.[Qt];q&&(q.duration=a.sample_deltas[T]),S.dts=q?q.dts+q.duration:0}h?(e>=A&&(k++,A<0&&(A=0),A+=h.sample_counts[k]),S.cts=t.samples[e].dts+h.sample_offsets[k]):S.cts=S.dts,l?(e==l.sample_numbers[ft]-1?(S.is_sync=!0,ft++):(S.is_sync=!1,S.degradation_priority=0),c&&c.entries[N].sample_delta+W==e+1&&(S.subsamples=c.entries[N].subsamples,W+=c.entries[N].sample_delta,N++)):S.is_sync=!0,y.process_sdtp(t.mdia.minf.stbl.sdtp,S,S.number),m?S.degradation_priority=m.priority[e]:S.degradation_priority=0,c&&c.entries[N].sample_delta+W==e&&(S.subsamples=c.entries[N].subsamples,W+=c.entries[N].sample_delta),(p.length>0||_.length>0)&&y.setSampleGroupProperties(t,S,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}};y.prototype.updateSampleLists=function(){var t,e,s,n,o,a,h,l,f,c,p,_,m,g,v;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(f=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,f.type=="moof")for(c=f,t=0;t<c.trafs.length;t++){for(p=c.trafs[t],_=this.getTrackById(p.tfhd.track_id),m=this.getTrexById(p.tfhd.track_id),p.tfhd.flags&r.TFHD_FLAG_SAMPLE_DESC?n=p.tfhd.default_sample_description_index:n=m?m.default_sample_description_index:1,p.tfhd.flags&r.TFHD_FLAG_SAMPLE_DUR?o=p.tfhd.default_sample_duration:o=m?m.default_sample_duration:0,p.tfhd.flags&r.TFHD_FLAG_SAMPLE_SIZE?a=p.tfhd.default_sample_size:a=m?m.default_sample_size:0,p.tfhd.flags&r.TFHD_FLAG_SAMPLE_FLAGS?h=p.tfhd.default_sample_flags:h=m?m.default_sample_flags:0,p.sample_number=0,p.sbgps.length>0&&y.initSampleGroups(_,p,p.sbgps,_.mdia.minf.stbl.sgpds,p.sgpds),e=0;e<p.truns.length;e++){var x=p.truns[e];for(s=0;s<x.sample_count;s++){g={},g.moof_number=this.lastMoofIndex,g.number_in_traf=p.sample_number,p.sample_number++,g.number=_.samples.length,p.first_sample_index=_.samples.length,_.samples.push(g),g.track_id=_.tkhd.track_id,g.timescale=_.mdia.mdhd.timescale,g.description_index=n-1,g.description=_.mdia.minf.stbl.stsd.entries[g.description_index],g.size=a,x.flags&r.TRUN_FLAGS_SIZE&&(g.size=x.sample_size[s]),_.samples_size+=g.size,g.duration=o,x.flags&r.TRUN_FLAGS_DURATION&&(g.duration=x.sample_duration[s]),_.samples_duration+=g.duration,_.first_traf_merged||s>0?g.dts=_.samples[_.samples.length-2].dts+_.samples[_.samples.length-2].duration:(p.tfdt?g.dts=p.tfdt.baseMediaDecodeTime:g.dts=0,_.first_traf_merged=!0),g.cts=g.dts,x.flags&r.TRUN_FLAGS_CTS_OFFSET&&(g.cts=g.dts+x.sample_composition_time_offset[s]),v=h,x.flags&r.TRUN_FLAGS_FLAGS?v=x.sample_flags[s]:s===0&&x.flags&r.TRUN_FLAGS_FIRST_FLAG&&(v=x.first_sample_flags),g.is_sync=!(v>>16&1),g.is_leading=v>>26&3,g.depends_on=v>>24&3,g.is_depended_on=v>>22&3,g.has_redundancy=v>>20&3,g.degradation_priority=v&65535;var I=!!(p.tfhd.flags&r.TFHD_FLAG_BASE_DATA_OFFSET),P=!!(p.tfhd.flags&r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),B=!!(x.flags&r.TRUN_FLAGS_DATA_OFFSET),T=0;I?T=p.tfhd.base_data_offset:P||e===0?T=c.start:T=l,e===0&&s===0?B?g.offset=T+x.data_offset:g.offset=T:g.offset=l,l=g.offset+g.size,(p.sbgps.length>0||p.sgpds.length>0||_.mdia.minf.stbl.sbgps.length>0||_.mdia.minf.stbl.sgpds.length>0)&&y.setSampleGroupProperties(_,g,g.number_in_traf,p.sample_groups_info)}}if(p.subs){_.has_fragment_subsamples=!0;var A=p.first_sample_index;for(e=0;e<p.subs.entries.length;e++)A+=p.subs.entries[e].sample_delta,g=_.samples[A-1],g.subsamples=p.subs.entries[e].subsamples}}}};y.prototype.getSample=function(t,e){var s,n=t.samples[e];if(!this.moov)return null;if(!n.data)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.samplesDataSize+=n.size,u.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+n.size+" (total: "+this.samplesDataSize+")");else if(n.alreadyRead==n.size)return n;for(;;){var o=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(o>-1){s=this.stream.buffers[o];var a=s.byteLength-(n.offset+n.alreadyRead-s.fileStart);if(n.size-n.alreadyRead<=a)return u.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-s.fileStart)+" read size: "+(n.size-n.alreadyRead)+" full size: "+n.size+")"),d.memcpy(n.data.buffer,n.alreadyRead,s,n.offset+n.alreadyRead-s.fileStart,n.size-n.alreadyRead),s.usedBytes+=n.size-n.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead=n.size,n;if(a===0)return null;u.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-s.fileStart)+" read size: "+a+" full size: "+n.size+")"),d.memcpy(n.data.buffer,n.alreadyRead,s,n.offset+n.alreadyRead-s.fileStart,a),n.alreadyRead+=a,s.usedBytes+=a,this.stream.logBufferLevel()}else return null}};y.prototype.releaseSample=function(t,e){var s=t.samples[e];return s.data?(this.samplesDataSize-=s.size,s.data=null,s.alreadyRead=0,s.size):0};y.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize};y.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var s=this.moov.traks[t];t>0&&(e+=","),e+=s.mdia.minf.stbl.stsd.entries[0].getCodec()}return e};y.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var s=this.moov.mvex.trexs[e];if(s.track_id==t)return s}return null};y.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var s=this.moov.traks[e];if(s.tkhd.track_id==t)return s}return null};y.prototype.items=[];y.prototype.entity_groups=[];y.prototype.itemsDataSize=0;y.prototype.flattenItemInfo=function(){var t=this.items,e=this.entity_groups,s,n,o,a=this.meta;if(a!=null&&a.hdlr!==void 0&&a.iinf!==void 0){for(s=0;s<a.iinf.item_infos.length;s++)o={},o.id=a.iinf.item_infos[s].item_ID,t[o.id]=o,o.ref_to=[],o.name=a.iinf.item_infos[s].item_name,a.iinf.item_infos[s].protection_index>0&&(o.protection=a.ipro.protections[a.iinf.item_infos[s].protection_index-1]),a.iinf.item_infos[s].item_type?o.type=a.iinf.item_infos[s].item_type:o.type="mime",o.content_type=a.iinf.item_infos[s].content_type,o.content_encoding=a.iinf.item_infos[s].content_encoding;if(a.grpl)for(s=0;s<a.grpl.boxes.length;s++)entity_group={},entity_group.id=a.grpl.boxes[s].group_id,entity_group.entity_ids=a.grpl.boxes[s].entity_ids,entity_group.type=a.grpl.boxes[s].type,e[entity_group.id]=entity_group;if(a.iloc)for(s=0;s<a.iloc.items.length;s++){var h=a.iloc.items[s];switch(o=t[h.item_ID],h.data_reference_index!==0&&(u.warn("Item storage with reference to other files: not supported"),o.source=a.dinf.boxes[h.data_reference_index-1]),h.construction_method){case 0:break;case 1:u.warn("Item storage with construction_method : not supported");break;case 2:u.warn("Item storage with construction_method : not supported");break}for(o.extents=[],o.size=0,n=0;n<h.extents.length;n++)o.extents[n]={},o.extents[n].offset=h.extents[n].extent_offset+h.base_offset,o.extents[n].length=h.extents[n].extent_length,o.extents[n].alreadyRead=0,o.size+=o.extents[n].length}if(a.pitm&&(t[a.pitm.item_id].primary=!0),a.iref)for(s=0;s<a.iref.references.length;s++){var l=a.iref.references[s];for(n=0;n<l.references.length;n++)t[l.from_item_ID].ref_to.push({type:l.type,id:l.references[n]})}if(a.iprp)for(var f=0;f<a.iprp.ipmas.length;f++){var c=a.iprp.ipmas[f];for(s=0;s<c.associations.length;s++){var p=c.associations[s];if(o=t[p.id],o||(o=e[p.id]),o)for(o.properties===void 0&&(o.properties={},o.properties.boxes=[]),n=0;n<p.props.length;n++){var _=p.props[n];if(_.property_index>0&&_.property_index-1<a.iprp.ipco.boxes.length){var m=a.iprp.ipco.boxes[_.property_index-1];o.properties[m.type]=m,o.properties.boxes.push(m)}}}}}};y.prototype.getItem=function(t){var e,s;if(!this.meta)return null;if(s=this.items[t],!s.data&&s.size)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.itemsDataSize+=s.size,u.debug("ISOFile","Allocating item #"+t+" of size "+s.size+" (total: "+this.itemsDataSize+")");else if(s.alreadyRead===s.size)return s;for(var n=0;n<s.extents.length;n++){var o=s.extents[n];if(o.alreadyRead!==o.length){var a=this.stream.findPosition(!0,o.offset+o.alreadyRead,!1);if(a>-1){e=this.stream.buffers[a];var h=e.byteLength-(o.offset+o.alreadyRead-e.fileStart);if(o.length-o.alreadyRead<=h)u.debug("ISOFile","Getting item #"+t+" extent #"+n+" data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-e.fileStart)+" read size: "+(o.length-o.alreadyRead)+" full extent size: "+o.length+" full item size: "+s.size+")"),d.memcpy(s.data.buffer,s.alreadyRead,e,o.offset+o.alreadyRead-e.fileStart,o.length-o.alreadyRead),e.usedBytes+=o.length-o.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead+=o.length-o.alreadyRead,o.alreadyRead=o.length;else return u.debug("ISOFile","Getting item #"+t+" extent #"+n+" partial data (alreadyRead: "+o.alreadyRead+" offset: "+(o.offset+o.alreadyRead-e.fileStart)+" read size: "+h+" full extent size: "+o.length+" full item size: "+s.size+")"),d.memcpy(s.data.buffer,s.alreadyRead,e,o.offset+o.alreadyRead-e.fileStart,h),o.alreadyRead+=h,s.alreadyRead+=h,e.usedBytes+=h,this.stream.logBufferLevel(),null}else return null}}return s.alreadyRead===s.size?s:null};y.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var s=0;s<e.extents.length;s++){var n=e.extents[s];n.alreadyRead=0}return e.size}else return 0};y.prototype.processItems=function(t){for(var e in this.items){var s=this.items[e];this.getItem(s.id),t&&!s.sent&&(t(s),s.sent=!0,s.data=null)}};y.prototype.hasItem=function(t){for(var e in this.items){var s=this.items[e];if(s.name===t)return s.id}return-1};y.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null};y.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)};y.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},s=null;if(e.itemId?s=this.getItem(e.itemId):s=this.getPrimaryItem(),s==null)return null;var n=new y;n.discardMdatData=!1;var o={type:s.type,description_boxes:s.properties.boxes};s.properties.ispe&&(o.width=s.properties.ispe.image_width,o.height=s.properties.ispe.image_height);var a=n.addTrack(o);return a?(n.addSample(a,s.data),n):null};y.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)};y.prototype.createFragment=function(t,e,s){var n=this.getTrackById(t),o=this.getSample(n,e);if(o==null)return this.setNextSeekPositionFromSample(n.samples[e]),null;var a=s||new d;a.endianness=d.BIG_ENDIAN;var h=this.createSingleSampleMoof(o);h.write(a),h.trafs[0].truns[0].data_offset=h.size+8,u.debug("MP4Box","Adjusting data_offset with new value "+h.trafs[0].truns[0].data_offset),a.adjustUint32(h.trafs[0].truns[0].data_offset_position,h.trafs[0].truns[0].data_offset);var l=new r.mdatBox;return l.data=o.data,l.write(a),a};y.writeInitializationSegment=function(t,e,s,n){var o;u.debug("ISOFile","Generating initialization segment");var a=new d;a.endianness=d.BIG_ENDIAN,t.write(a);var h=e.add("mvex");for(s&&h.add("mehd").set("fragment_duration",s),o=0;o<e.traks.length;o++)h.add("trex").set("track_id",e.traks[o].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",n).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(a),a.buffer};y.prototype.save=function(t){var e=new d;e.endianness=d.BIG_ENDIAN,this.write(e),e.save(t)};y.prototype.getBuffer=function(){var t=new d;return t.endianness=d.BIG_ENDIAN,this.write(t),t.buffer};y.prototype.initializeSegmentation=function(){var t,e,s,n;for(this.onSegment===null&&u.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var o=new r.moovBox;o.mvhd=this.moov.mvhd,o.boxes.push(o.mvhd),s=this.getTrackById(this.fragmentedTracks[t].id),o.boxes.push(s),o.traks.push(s),n={},n.id=s.tkhd.track_id,n.user=this.fragmentedTracks[t].user,n.buffer=y.writeInitializationSegment(this.ftyp,o,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(n)}return e};r.Box.prototype.printHeader=function(t){this.size+=8,this.size>H&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)};r.FullBox.prototype.printHeader=function(t){this.size+=4,r.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)};r.Box.prototype.print=function(t){this.printHeader(t)};r.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var s=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=s}};y.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)};r.mvhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)};r.tkhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var Xt={};Xt.createFile=function(t,e){var s=t!==void 0?t:!0,n=new y(e);return n.discardMdatData=!s,n};const ri=new Uint8Array([0,0,4,176,109,111,111,118,0,0,0,108,109,118,104,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,232,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1,243,116,114,97,107,0,0,0,92,116,107,104,100,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,5,0,0,0,2,208,0,0,0,0,1,143,109,100,105,97,0,0,0,32,109,100,104,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,128,0,0,0,0,85,196,0,0,0,0,0,45,104,100,108,114,0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0,0,0,1,58,109,105,110,102,0,0,0,20,118,109,104,100,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,36,100,105,110,102,0,0,0,28,100,114,101,102,0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1,0,0,0,250,115,116,98,108,0,0,0,174,115,116,115,100,0,0,0,0,0,0,0,1,0,0,0,158,97,118,99,49,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,2,208,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255,0,0,0,52,97,118,99,67,1,100,0,31,255,225,0,24,103,100,0,31,172,217,64,80,5,186,16,0,0,3,0,16,0,0,125,0,241,131,25,96,1,0,5,104,235,236,178,44,253,248,248,0,0,0,0,20,98,116,114,116,0,0,0,0,0,27,158,99,0,27,158,99,0,0,0,16,115,116,116,115,0,0,0,0,0,0,0,0,0,0,0,16,115,116,115,99,0,0,0,0,0,0,0,0,0,0,0,20,115,116,115,122,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,115,116,99,111,0,0,0,0,0,0,0,0,0,0,1,160,116,114,97,107,0,0,0,92,116,107,104,100,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,1,60,109,100,105,97,0,0,0,32,109,100,104,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,187,128,0,0,0,0,85,196,0,0,0,0,0,45,104,100,108,114,0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0,0,0,0,231,109,105,110,102,0,0,0,16,115,109,104,100,0,0,0,0,0,0,0,0,0,0,0,36,100,105,110,102,0,0,0,28,100,114,101,102,0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1,0,0,0,171,115,116,98,108,0,0,0,95,115,116,115,100,0,0,0,0,0,0,0,1,0,0,0,79,79,112,117,115,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,0,0,0,187,128,0,0,0,0,0,23,100,79,112,115,0,2,0,0,0,0,187,128,0,0,255,2,0,0,1,0,0,0,20,98,116,114,116,0,0,0,0,0,1,248,176,0,1,248,176,0,0,0,16,115,116,116,115,0,0,0,0,0,0,0,0,0,0,0,16,115,116,115,99,0,0,0,0,0,0,0,0,0,0,0,20,115,116,115,122,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,115,116,99,111,0,0,0,0,0,0,0,0,0,0,0,72,109,118,101,120,0,0,0,32,116,114,101,120,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,32,116,114,101,120,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,97,117,100,116,97,0,0,0,89,109,101,116,97,0,0,0,0,0,0,0,33,104,100,108,114,0,0,0,0,0,0,0,0,109,100,105,114,97,112,112,108,0,0,0,0,0,0,0,0,0,0,0,0,44,105,108,115,116,0,0,0,36,169,116,111,111,0,0,0,28,100,97,116,97,0,0,0,1,0,0,0,0,76,97,118,102,54,48,46,51,46,49,48,48]);function xt(...t){let e=0;for(const o of t)e+=o.length;const s=new Uint8Array(e);let n=0;for(const o of t)s.set(o,n),n+=o.length;return s}function oi(t,e,s){let n=()=>{};const o=new Promise((h,l)=>{n=l;const f=Xt.createFile(!1);f.initialSample=s.lastSample;let c=new Uint8Array,p=0;f.onReady=async({tracks:g})=>{for(const x of g)f.setSegmentOptions(x.id,null),p=x.id;let v=!1;for(const{buffer:x}of f.initializeSegmentation())e&&!v&&(c=xt(c,new Uint8Array(x)),v=!0);f.nextMoofNumber=s.lastSeq,f.start()};const _={};f.onSegment=async(g,v,x,I,P)=>{if(c=xt(c,new Uint8Array(x)),P){const B=f.getTrackById(g).samples;_[g]=B[B.length-1]}P&&g==p&&(e&&(c=ai(c)),h([c,{lastSeq:f.nextMoofNumber,lastSample:_}]))};const m=t.buffer;m.fileStart=0,f.appendBuffer(m)}),a=setTimeout(()=>{n(new Error("divideToFragments took too long"))},3e4);return o.then(()=>{clearTimeout(a)}),o}function ai(t){let e=0;const s=new DataView(t.buffer,t.byteOffset,t.byteLength);for(;e<t.byteLength;){const n=s.getUint32(e);if(new TextDecoder().decode(t.slice(e+4,e+8))=="moov"){const a=t.subarray(0,e),h=t.subarray(e);return xt(a,ri,h)}e+=n}return t}const at=new Map;function hi(t,e){const s=at.get(e);s?s.controllers.push({inited:!1,controller:t}):at.set(e,{controllers:[{inited:!1,controller:t}],state:{lastSeq:0}})}function li(t,e){const s=at.get(e);s&&(s.controllers=s.controllers.filter(n=>t!=n.controller))}const fi={appendLiveStreamChunk:async({chunk:t,ts:e,groupCallId:s})=>{const n=at.get(s);if(n&&!(n.state.lastTs&&BigInt(e)<=n.state.lastTs)){n.state.lastTs=BigInt(e);for(const o of n.controllers){const[a,h]=await oi(t,!o.inited,n.state);o.inited=!0,n.state=h,o.controller.enqueue(a)}}}};function di(t,e){let s=null;const n=new ReadableStream({start(o){hi(s=o,e)},cancel(){s&&li(s,e)}});t.respondWith(new Response(n,{headers:{"content-type":"video/mp4"}}))}function ci(t){t.addMultipleEventsListeners(fi)}const U=nt("SW",$.Error|$.Debug|$.Log|$.Warn,!0),L=self;let j;const $t=()=>j;U("init");const ui=t=>{const e=new MessageChannel;C.attachPort(j=e.port1),C.invokeVoid("port",void 0,t,[e.port2])},pi=t=>{!D.size&&!j&&(U("sending message port for mtproto"),ui(t))},Zt=t=>{if(U("window connected",t.id,"windows before",D.size),t.frameType==="none"){U.warn("maybe a bugged Safari starting window",t.id);return}U("windows",Array.from(D)),C.invokeVoid("hello",void 0,t),pi(t),D.set(t.id,t),si(t)},C=new Ke;C.addMultipleEventsListeners({notificationsClear:Me,toggleStorages:({enabled:t,clearWrite:e})=>{rt.toggleStorage(t,e)},pushPing:(t,e)=>{Ge(t,e)},hello:(t,e)=>{Zt(e)},shownNotification:He});const{onDownloadFetch:_i,onClosedWindows:gi}=Je(C);ci(C);Ft().then(t=>{U(`got ${t.length} windows from the start`),t.forEach(e=>{Zt(e)})});const D=new Map;self.connectedWindows=D;Xe(C,void 0,t=>{if(U("something has disconnected",t),!(t instanceof WindowClient)||!D.has(t.id)){U.warn("it is not a window");return}D.delete(t.id),U("window disconnected, left",D.size),D.size||(U.warn("no windows left"),j&&(C.detachPort(j),j=void 0),gi())});const yi=t=>{if(!It&&t.request.url.indexOf(location.origin+"/")===0&&t.request.url.match(/\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\?.*)?$/))return t.respondWith(fe(t));try{const[e,s]=t.request.url.split("/").slice(-2);switch(e){case"stream":{Ue(t,s);break}case"download":{_i(t,s);break}case"share":{ni(t,s);break}case"ping":{t.respondWith(new Response("pong"));break}case"livestream":{di(t,s);break}}}catch(e){U.error("fetch error",e),t.respondWith(new Response("",{status:500,statusText:"Internal Server Error",headers:{"Cache-Control":"no-cache"}}))}},Jt=()=>{L.onfetch=yi};L.addEventListener("install",t=>{U("installing"),t.waitUntil(L.skipWaiting().then(()=>U("skipped waiting")))});L.addEventListener("activate",t=>{U("activating",L),t.waitUntil(L.caches.delete(Nt).then(()=>U("cleared assets cache"))),t.waitUntil(L.clients.claim().then(()=>U("claimed clients")))});L.onoffline=L.ononline=Jt;Jt()});export default mi();
//# sourceMappingURL=sw-yTyW_zDZ.js.map
